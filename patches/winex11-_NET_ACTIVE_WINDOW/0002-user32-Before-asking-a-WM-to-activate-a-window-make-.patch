From 731298c0bd68f8ff4368a119cdb5e8e7fe0d0950 Mon Sep 17 00:00:00 2001
From: Dmitry Timoshkov <dmitry@baikal.ru>
Date: Wed, 6 Apr 2016 15:14:25 +0800
Subject: user32: Before asking a WM to activate a window make sure that the
 window is in foreground and not minimized.

This patch fixes iconify action using WM's taskbar buttons for Winamp.
---
 dlls/user32/focus.c | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

diff --git a/dlls/user32/focus.c b/dlls/user32/focus.c
index 1c705d5..d52c3f5 100644
--- a/dlls/user32/focus.c
+++ b/dlls/user32/focus.c
@@ -154,9 +154,10 @@ static BOOL set_active_window( HWND hwnd, HWND *prev, BOOL mouse, BOOL focus )
         SendMessageW( hwnd, WM_ACTIVATE,
                       MAKEWPARAM( mouse ? WA_CLICKACTIVE : WA_ACTIVE, IsIconic(hwnd) ),
                       (LPARAM)previous );
-    }
 
-    USER_Driver->pSetActiveWindow( hwnd );
+        if (hwnd == GetForegroundWindow() && !IsIconic( hwnd ))
+            USER_Driver->pSetActiveWindow( hwnd );
+    }
 
     /* now change focus if necessary */
     if (focus)
-- 
2.7.1

