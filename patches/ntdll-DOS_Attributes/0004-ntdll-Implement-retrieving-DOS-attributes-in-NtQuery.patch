From 2e97bfb51b37d8b3bd85a486b706bb1608ebd132 Mon Sep 17 00:00:00 2001
From: "Erich E. Hoover" <erich.e.hoover@gmail.com>
Date: Wed, 20 Aug 2014 16:05:38 -0600
Subject: ntdll: Implement retrieving DOS attributes in NtQueryDirectoryFile.

---
 dlls/ntdll/directory.c  |    9 ++-------
 dlls/ntdll/ntdll_misc.h |    1 +
 2 files changed, 3 insertions(+), 7 deletions(-)

diff --git a/dlls/ntdll/directory.c b/dlls/ntdll/directory.c
index 678aef5..9fb4b87 100644
--- a/dlls/ntdll/directory.c
+++ b/dlls/ntdll/directory.c
@@ -1381,7 +1381,7 @@ static union file_directory_info *append_entry( void *info_ptr, IO_STATUS_BLOCK
     WCHAR *filename;
     UNICODE_STRING str;
     ULONG attributes = 0;
-    ULONG xattr = 0;
+    ULONG xattr;
 
     io->u.Status = STATUS_SUCCESS;
     long_len = ntdll_umbstowcs( 0, long_name, strlen(long_name), long_nameW, MAX_DIR_ENTRY_LEN );
@@ -1418,12 +1418,7 @@ static union file_directory_info *append_entry( void *info_ptr, IO_STATUS_BLOCK
         if (!match_filename( &str, mask )) return NULL;
     }
 
-    if (lstat( long_name, &st ) == -1) return NULL;
-    if (S_ISLNK( st.st_mode ))
-    {
-        if (stat( long_name, &st ) == -1) return NULL;
-        if (S_ISDIR( st.st_mode )) attributes |= FILE_ATTRIBUTE_REPARSE_POINT;
-    }
+    if (get_file_info( long_name, &st, &xattr ) == -1) return NULL;
     if (is_ignored_file( &st ))
     {
         TRACE( "ignoring file %s\n", long_name );
diff --git a/dlls/ntdll/ntdll_misc.h b/dlls/ntdll/ntdll_misc.h
index ec96427..226bc85 100644
--- a/dlls/ntdll/ntdll_misc.h
+++ b/dlls/ntdll/ntdll_misc.h
@@ -148,6 +148,7 @@ extern NTSTATUS COMM_FlushBuffersFile( int fd ) DECLSPEC_HIDDEN;
 /* file I/O */
 struct stat;
 extern NTSTATUS FILE_GetNtStatus(void) DECLSPEC_HIDDEN;
+extern int get_file_info( const char *path, struct stat *st, ULONG *xattr ) DECLSPEC_HIDDEN;
 extern NTSTATUS fill_file_info( ULONG xattr, const struct stat *st, void *ptr, FILE_INFORMATION_CLASS class ) DECLSPEC_HIDDEN;
 extern NTSTATUS server_get_unix_name( HANDLE handle, ANSI_STRING *unix_name ) DECLSPEC_HIDDEN;
 extern void DIR_init_windows_dir( const WCHAR *windir, const WCHAR *sysdir ) DECLSPEC_HIDDEN;
-- 
1.7.9.5

