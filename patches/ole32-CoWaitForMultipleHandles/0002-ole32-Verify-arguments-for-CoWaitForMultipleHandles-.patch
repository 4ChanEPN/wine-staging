From ed866ac6a70e8309ea539b0f4bb03a0a7d73029f Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Wed, 5 Nov 2014 00:39:51 +0100
Subject: ole32: Verify arguments for CoWaitForMultipleHandles, always
 initialize index to zero.

---
 dlls/ole32/compobj.c       | 11 +++++++++++
 dlls/ole32/tests/compobj.c | 13 -------------
 2 files changed, 11 insertions(+), 13 deletions(-)

diff --git a/dlls/ole32/compobj.c b/dlls/ole32/compobj.c
index 1fab04f..1d9b943 100644
--- a/dlls/ole32/compobj.c
+++ b/dlls/ole32/compobj.c
@@ -4431,6 +4431,17 @@ HRESULT WINAPI CoWaitForMultipleHandles(DWORD dwFlags, DWORD dwTimeout,
     TRACE("(0x%08x, 0x%08x, %d, %p, %p)\n", dwFlags, dwTimeout, cHandles,
         pHandles, lpdwindex);
 
+    if (!lpdwindex)
+        return E_INVALIDARG;
+
+    *lpdwindex = 0;
+
+    if (!pHandles)
+        return E_INVALIDARG;
+
+    if (!cHandles)
+        return RPC_E_NO_SYNC;
+
     while (TRUE)
     {
         DWORD now = GetTickCount();
diff --git a/dlls/ole32/tests/compobj.c b/dlls/ole32/tests/compobj.c
index de4c64f..8b864bf 100644
--- a/dlls/ole32/tests/compobj.c
+++ b/dlls/ole32/tests/compobj.c
@@ -2132,31 +2132,23 @@ static void test_CoWaitForMultipleHandles(void)
     index = 0xdeadbeef;
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(0, 50, 0, NULL, &index);
-    todo_wine
     ok(hr == E_INVALIDARG, "expected hr E_INVALIDARG, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
-    todo_wine
     ok(success, "CoWaitForMultipleHandles unexpectedly pumped messages\n");
 
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(0, 50, 0, handles, NULL);
-    todo_wine
     ok(hr == E_INVALIDARG, "expected hr E_INVALIDARG, got 0x%08x\n", hr);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
-    todo_wine
     ok(success, "CoWaitForMultipleHandles unexpectedly pumped messages\n");
 
     index = 0xdeadbeef;
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(0, 50, 0, handles, &index);
-    todo_wine
     ok(hr == RPC_E_NO_SYNC, "expected hr RPC_E_NO_SYNC, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
-    todo_wine
     ok(success, "CoWaitForMultipleHandles unexpectedly pumped messages\n");
 
     index = 0xdeadbeef;
@@ -2179,7 +2171,6 @@ static void test_CoWaitForMultipleHandles(void)
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(0, 50, 2, handles, &index);
     ok(hr == RPC_S_CALLPENDING, "expected hr RPC_S_CALLPENDING, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
     ok(!success, "CoWaitForMultipleHandles didn't pump any messages\n");
@@ -2201,7 +2192,6 @@ static void test_CoWaitForMultipleHandles(void)
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(0, 50, 2, handles, &index);
     ok(hr == RPC_S_CALLPENDING, "expected hr RPC_S_CALLPENDING, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
     ok(!success, "CoWaitForMultipleHandles didn't pump any messages\n");
@@ -2231,7 +2221,6 @@ static void test_CoWaitForMultipleHandles(void)
     PostMessageA(hWnd, WM_DDE_FIRST, 0, 0);
     hr = CoWaitForMultipleHandles(COWAIT_ALERTABLE, 50, 2, handles, &index);
     ok(hr == RPC_S_CALLPENDING, "expected hr RPC_S_CALLPENDING, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
     ok(!success, "CoWaitForMultipleHandles didn't pump any messages\n");
@@ -2256,7 +2245,6 @@ static void test_CoWaitForMultipleHandles(void)
     ok(success, "PeekMessageA returned FALSE\n");
     hr = CoWaitForMultipleHandles(0, 50, 2, handles, &index);
     ok(hr == RPC_S_CALLPENDING, "expected hr RPC_S_CALLPENDING, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
     ok(!success, "CoWaitForMultipleHandles didn't pump any messages\n");
@@ -2268,7 +2256,6 @@ static void test_CoWaitForMultipleHandles(void)
     hr = CoWaitForMultipleHandles(COWAIT_INPUTAVAILABLE, 50, 2, handles, &index);
     ok(hr == RPC_S_CALLPENDING || broken(hr == E_INVALIDARG),
        "expected hr RPC_S_CALLPENDING, got 0x%08x\n", hr);
-    todo_wine
     ok(index == 0, "expected index 0, got %u\n", index);
     success = PeekMessageA(&msg, hWnd, WM_DDE_FIRST, WM_DDE_FIRST, PM_REMOVE);
     ok(!success || broken(hr == E_INVALIDARG && success),
-- 
2.1.3

