From af3adabd17da448810f2daa67994e664c7418d52 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Fri, 9 Jan 2015 03:44:39 +0100
Subject: nvcuda: Workaround for segmentation fault caused by missing callback
 relay.

---
 dlls/nvcuda/internal.c | 12 +++++++++++-
 1 file changed, 11 insertions(+), 1 deletion(-)

diff --git a/dlls/nvcuda/internal.c b/dlls/nvcuda/internal.c
index 4e733eb..0a96ada 100755
--- a/dlls/nvcuda/internal.c
+++ b/dlls/nvcuda/internal.c
@@ -237,7 +237,17 @@ void* WINAPI Unknown1_func3_relay(void *param0, void *param1)
 void* WINAPI Unknown1_func4_relay(void *param0)
 {
     FIXME("(%p)\n", param0);
-    return Unknown1_orig->func4(param0);
+
+    /*
+     * For some reason this function causes a segementation fault.
+     * The function is called during the deinitilization of cuda
+     * and the parameter seems to be some kind of device id.
+     * For programs using 2 GPUs you will see the values 0 and 1.
+     * The logic of this functions does not seem to be critical
+     * for a working cuda implementation and is therefore stubbed
+     * till we find a way to prevent the crash.
+     */
+    return CUDA_SUCCESS;
 }
 
 struct Unknown1_table Unknown1_Impl =
-- 
2.2.1

