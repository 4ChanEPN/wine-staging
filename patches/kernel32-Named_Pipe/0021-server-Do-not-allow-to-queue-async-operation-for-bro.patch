From a5a9edf432ca2aecef11db6bde388730cc9eadf8 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Wed, 24 Feb 2016 15:45:09 +0100
Subject: server: Do not allow to queue async operation for broken pipes.

---
 server/named_pipe.c | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/server/named_pipe.c b/server/named_pipe.c
index 9a8d8b37ca..df9f5c4926 100644
--- a/server/named_pipe.c
+++ b/server/named_pipe.c
@@ -665,8 +665,20 @@ static obj_handle_t pipe_client_flush( struct fd *fd, struct async *async, int b
 static void pipe_end_queue_async( struct fd *fd, struct async *async, int type, int count )
 {
     struct pipe_end *pipe_end = get_fd_user( fd );
-    if (use_server_io( pipe_end )) no_fd_queue_async( fd, async, type, count );
-    else default_fd_queue_async( fd, async, type, count );
+
+    if (use_server_io( pipe_end ))
+    {
+        no_fd_queue_async( fd, async, type, count );
+        return;
+    }
+
+    if (!pipe_end->connection)
+    {
+        set_error( STATUS_PIPE_BROKEN );
+        return;
+    }
+
+    default_fd_queue_async( fd, async, type, count );
 }
 
 static inline int is_overlapped( unsigned int options )
-- 
2.11.0

