From 6e6cd9108a8f3c0b9d158ac2605e9b0a08b19c71 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Sat, 28 Feb 2015 06:58:48 +0100
Subject: server: Implement waiting for job objects.

---
 dlls/kernel32/tests/process.c | 2 --
 server/process.c              | 7 ++++++-
 2 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/dlls/kernel32/tests/process.c b/dlls/kernel32/tests/process.c
index aaa1a6e..c325d32 100644
--- a/dlls/kernel32/tests/process.c
+++ b/dlls/kernel32/tests/process.c
@@ -2482,7 +2482,6 @@ static void test_WaitForJobObject(void)
     ok(ret, "TerminateJobObject error %u\n", GetLastError());
 
     dwret = WaitForSingleObject(job, 500);
-    todo_wine
     ok(dwret == WAIT_OBJECT_0 || broken(dwret == WAIT_TIMEOUT),
        "WaitForSingleObject returned %u\n", dwret);
 
@@ -2491,7 +2490,6 @@ static void test_WaitForJobObject(void)
         CloseHandle(pi.hProcess);
         CloseHandle(pi.hThread);
         CloseHandle(job);
-        todo_wine
         win_skip("TerminateJobObject doesn't signal job, skipping tests\n");
         return;
     }
diff --git a/server/process.c b/server/process.c
index 3ff0be5..f59fe2b 100644
--- a/server/process.c
+++ b/server/process.c
@@ -151,6 +151,7 @@ struct job
     int num_processes;             /* count of running processes */
     unsigned int limit_flags;      /* limit flags */
     int terminating;               /* job is terminating */
+    int signaled;                  /* job is signaled */
     struct completion *completion_port; /* associated completion port */
     apc_param_t completion_key;    /* key to send with completion messages */
 };
@@ -193,6 +194,7 @@ static struct job *create_job_object( struct directory *root, const struct unico
             job->num_processes = 0;
             job->limit_flags = 0;
             job->terminating = 0;
+            job->signaled = 0;
             job->completion_port = NULL;
             job->completion_key = 0;
         }
@@ -284,6 +286,8 @@ static void terminate_job( struct job *job, int exit_code )
     }
 
     job->terminating = 0;
+    job->signaled = 1;
+    wake_up( &job->obj, 0 );
 }
 
 static int job_close_handle( struct object *obj, struct process *process, obj_handle_t handle )
@@ -320,7 +324,8 @@ static void job_dump( struct object *obj, int verbose )
 
 static int job_signaled( struct object *obj, struct wait_queue_entry *entry )
 {
-    return 0;
+    struct job *job = (struct job *)obj;
+    return job->signaled;
 }
 
 struct ptid_entry
-- 
2.3.3

