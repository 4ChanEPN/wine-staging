From 64ce8c391c3706a2b3ce9b5f8f76710d5751a766 Mon Sep 17 00:00:00 2001
From: Dmitry Timoshkov <dmitry@baikal.ru>
Date: Thu, 20 Oct 2016 17:48:24 +0800
Subject: avifil32: AVIFileGetStream should set stream to NULL in case of an
 error.

---
 dlls/avifil32/avifile.c   | 1 +
 dlls/avifil32/tests/api.c | 5 +++++
 2 files changed, 6 insertions(+)

diff --git a/dlls/avifil32/avifile.c b/dlls/avifil32/avifile.c
index f649d05..7a4caaa 100644
--- a/dlls/avifil32/avifile.c
+++ b/dlls/avifil32/avifile.c
@@ -316,6 +316,7 @@ static HRESULT WINAPI IAVIFile_fnGetStream(IAVIFile *iface, IAVIStream **avis, D
   }
 
   /* Sorry, but the specified stream doesn't exist */
+  *avis = NULL;
   return AVIERR_NODATA;
 }
 
diff --git a/dlls/avifil32/tests/api.c b/dlls/avifil32/tests/api.c
index b3d822d..8a00865 100644
--- a/dlls/avifil32/tests/api.c
+++ b/dlls/avifil32/tests/api.c
@@ -373,6 +373,11 @@ static void test_default_data(void)
     res = AVIFileOpenA(&pFile, filename, OF_SHARE_DENY_WRITE, 0L);
     ok(res == 0, "Unable to open file: error=%u\n", res);
 
+    pStream0 = (void *)0xdeadbeef;
+    res = AVIFileGetStream(pFile, &pStream0, ~0, 0);
+    ok(res == AVIERR_NODATA, "expected AVIERR_NODATA, got %#x\n", res);
+    ok(pStream0 == NULL, "AVIFileGetStream should set stream to NULL\n");
+
     res = AVIFileGetStream(pFile, &pStream0, 0, 0);
     ok(res == 0, "Unable to open video stream: error=%u\n", res);
 
-- 
2.9.0

