From 6a5243ef02834611838ca129057ff638262bded6 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Tue, 1 Nov 2016 14:58:21 +0100
Subject: Revert "wined3d: Replace wined3d_buffer_load_sysmem() calls with
 wined3d_buffer_load_location()."

This reverts commit 4a23e91462083db82058111977762532c86afcad.
---
 dlls/wined3d/buffer.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/dlls/wined3d/buffer.c b/dlls/wined3d/buffer.c
index 05be910..6af5529 100644
--- a/dlls/wined3d/buffer.c
+++ b/dlls/wined3d/buffer.c
@@ -631,7 +631,6 @@ void wined3d_buffer_get_memory(struct wined3d_buffer *buffer,
 static void buffer_unload(struct wined3d_resource *resource)
 {
     struct wined3d_buffer *buffer = buffer_from_resource(resource);
-    DWORD flags = buffer->flags;
 
     TRACE("buffer %p.\n", buffer);
 
@@ -642,10 +641,12 @@ static void buffer_unload(struct wined3d_resource *resource)
 
         context = context_acquire(device, NULL);
 
-        /* Download the buffer, but don't permanently enable double buffering. */
-        wined3d_buffer_load_location(buffer, context, WINED3D_LOCATION_SYSMEM);
-        if (!(flags & WINED3D_BUFFER_DOUBLEBUFFER))
+        /* Download the buffer, but don't permanently enable double buffering */
+        if (!(buffer->flags & WINED3D_BUFFER_DOUBLEBUFFER))
+        {
+            wined3d_buffer_load_sysmem(buffer, context);
             buffer->flags &= ~WINED3D_BUFFER_DOUBLEBUFFER;
+        }
 
         wined3d_buffer_invalidate_location(buffer, WINED3D_LOCATION_BUFFER);
         delete_gl_buffer(buffer, context->gl_info);
@@ -992,7 +993,8 @@ void wined3d_buffer_load(struct wined3d_buffer *buffer, struct wined3d_context *
     if (buffer->buffer_type_hint != GL_ARRAY_BUFFER)
         ERR("Converting data in non-vertex buffer.\n");
 
-    wined3d_buffer_load_location(buffer, context, WINED3D_LOCATION_SYSMEM);
+    if (!(buffer->flags & WINED3D_BUFFER_DOUBLEBUFFER))
+        wined3d_buffer_load_sysmem(buffer, context);
 
     /* Now for each vertex in the buffer that needs conversion */
     vertex_count = buffer->resource.size / buffer->stride;
@@ -1147,7 +1149,7 @@ static HRESULT wined3d_buffer_map(struct wined3d_buffer *buffer, UINT offset, UI
                     else
                     {
                         TRACE("Falling back to doublebuffered operation.\n");
-                        wined3d_buffer_load_location(buffer, context, WINED3D_LOCATION_SYSMEM);
+                        wined3d_buffer_load_sysmem(buffer, context);
                     }
                     TRACE("New pointer is %p.\n", buffer->resource.heap_memory);
                     buffer->map_ptr = NULL;
-- 
2.9.0

