From 1ec1c07173483456777e2d36cea321198ba1af98 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Sat, 3 Sep 2016 02:31:43 +0200
Subject: Revert "wined3d: Send resource unmaps through the command stream."

This reverts commit 66e54fd682f494265b6059d2f04d766ec085f149.
---
 dlls/wined3d/cs.c              | 34 ----------------------------------
 dlls/wined3d/resource.c        |  2 +-
 dlls/wined3d/wined3d_private.h |  2 --
 3 files changed, 1 insertion(+), 37 deletions(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 7af0b81..d86213b 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -58,7 +58,6 @@ enum wined3d_cs_op
     WINED3D_CS_OP_PRELOAD_RESOURCE,
     WINED3D_CS_OP_UNLOAD_RESOURCE,
     WINED3D_CS_OP_MAP,
-    WINED3D_CS_OP_UNMAP,
 };
 
 struct wined3d_cs_present
@@ -302,14 +301,6 @@ struct wined3d_cs_map
     HRESULT *hr;
 };
 
-struct wined3d_cs_unmap
-{
-    enum wined3d_cs_op opcode;
-    struct wined3d_resource *resource;
-    unsigned int sub_resource_idx;
-    HRESULT *hr;
-};
-
 static void wined3d_cs_exec_present(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_present *op = data;
@@ -1351,30 +1342,6 @@ HRESULT wined3d_cs_map(struct wined3d_cs *cs, struct wined3d_resource *resource,
     return hr;
 }
 
-static void wined3d_cs_exec_unmap(struct wined3d_cs *cs, const void *data)
-{
-    const struct wined3d_cs_unmap *op = data;
-    struct wined3d_resource *resource = op->resource;
-
-    *op->hr = resource->resource_ops->resource_sub_resource_unmap(resource, op->sub_resource_idx);
-}
-
-HRESULT wined3d_cs_unmap(struct wined3d_cs *cs, struct wined3d_resource *resource, unsigned int sub_resource_idx)
-{
-    struct wined3d_cs_unmap *op;
-    HRESULT hr;
-
-    op = cs->ops->require_space(cs, sizeof(*op));
-    op->opcode = WINED3D_CS_OP_UNMAP;
-    op->resource = resource;
-    op->sub_resource_idx = sub_resource_idx;
-    op->hr = &hr;
-
-    cs->ops->submit(cs);
-
-    return hr;
-}
-
 static void (* const wined3d_cs_op_handlers[])(struct wined3d_cs *cs, const void *data) =
 {
     /* WINED3D_CS_OP_PRESENT                    */ wined3d_cs_exec_present,
@@ -1409,7 +1376,6 @@ static void (* const wined3d_cs_op_handlers[])(struct wined3d_cs *cs, const void
     /* WINED3D_CS_OP_PRELOAD_RESOURCE           */ wined3d_cs_exec_preload_resource,
     /* WINED3D_CS_OP_UNLOAD_RESOURCE            */ wined3d_cs_exec_unload_resource,
     /* WINED3D_CS_OP_MAP                        */ wined3d_cs_exec_map,
-    /* WINED3D_CS_OP_UNMAP                      */ wined3d_cs_exec_unmap,
 };
 
 static void *wined3d_cs_st_require_space(struct wined3d_cs *cs, size_t size)
diff --git a/dlls/wined3d/resource.c b/dlls/wined3d/resource.c
index b3e2747..927e875 100644
--- a/dlls/wined3d/resource.c
+++ b/dlls/wined3d/resource.c
@@ -328,7 +328,7 @@ HRESULT CDECL wined3d_resource_unmap(struct wined3d_resource *resource, unsigned
 {
     TRACE("resource %p, sub_resource_idx %u.\n", resource, sub_resource_idx);
 
-    return wined3d_cs_unmap(resource->device->cs, resource, sub_resource_idx);
+    return resource->resource_ops->resource_sub_resource_unmap(resource, sub_resource_idx);
 }
 
 void CDECL wined3d_resource_preload(struct wined3d_resource *resource)
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index bedda9b..ad0578b 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -3098,8 +3098,6 @@ void wined3d_cs_emit_set_viewport(struct wined3d_cs *cs, const struct wined3d_vi
 void wined3d_cs_emit_unload_resource(struct wined3d_cs *cs, struct wined3d_resource *resource) DECLSPEC_HIDDEN;
 HRESULT wined3d_cs_map(struct wined3d_cs *cs, struct wined3d_resource *resource, unsigned int sub_resource_idx,
         struct wined3d_map_desc *map_desc, const struct wined3d_box *box, unsigned int flags) DECLSPEC_HIDDEN;
-HRESULT wined3d_cs_unmap(struct wined3d_cs *cs, struct wined3d_resource *resource,
-        unsigned int sub_resource_idx) DECLSPEC_HIDDEN;
 
 static inline void wined3d_cs_push_constants(struct wined3d_cs *cs, enum wined3d_push_constants p,
         unsigned int start_idx, unsigned int count, const void *constants)
-- 
2.9.0

