From 29e1173cde6166096974dabf1c6795ec41565e14 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michael=20M=C3=BCller?= <michael@fds-team.de>
Date: Tue, 7 Feb 2017 23:06:10 +0100
Subject: wined3d: Optimize cs queue empty check.

---
 dlls/wined3d/cs.c              | 3 +++
 dlls/wined3d/wined3d_private.h | 1 +
 2 files changed, 4 insertions(+)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 4cbab2a91f8..31c82b1b68c 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -542,12 +542,14 @@ static void wined3d_cs_list_enqueue(struct wined3d_cs_list *list, struct wined3d
     EnterCriticalSection(&wined3d_cs_list_mutex);
     list_add_tail(&list->blocks, &block->entry);
     LeaveCriticalSection(&wined3d_cs_list_mutex);
+    InterlockedIncrement(&list->count);
 }
 
 static struct wined3d_cs_block *wined3d_cs_list_dequeue(struct wined3d_cs_list *list)
 {
     struct list *head;
 
+    if (!list->count) return NULL;
     EnterCriticalSection(&wined3d_cs_list_mutex);
     if (!(head = list_head(&list->blocks)))
     {
@@ -556,6 +558,7 @@ static struct wined3d_cs_block *wined3d_cs_list_dequeue(struct wined3d_cs_list *
     }
     list_remove(head);
     LeaveCriticalSection(&wined3d_cs_list_mutex);
+    InterlockedDecrement(&list->count);
 
     return LIST_ENTRY(head, struct wined3d_cs_block, entry);
 }
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 110fbfde605..a99a4513cef 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -3169,6 +3169,7 @@ enum wined3d_push_constants
 struct wined3d_cs_list
 {
     struct list blocks;
+    LONG count;
 };
 
 struct wined3d_cs_block
-- 
2.11.0

