From 6e41725a162f9ad5acc17733be62667570435c5a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michael=20M=C3=BCller?= <michael@fds-team.de>
Date: Sat, 18 Feb 2017 00:45:39 +0100
Subject: wined3d: Don't wait for events that have not been issued yet.

---
 dlls/wined3d/cs.c              | 4 ++++
 dlls/wined3d/query.c           | 6 +++++-
 dlls/wined3d/wined3d_private.h | 1 +
 3 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 91089ff9df..4086e3c7f3 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -1784,11 +1784,15 @@ static UINT wined3d_cs_exec_query_issue(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_query_issue *op = data;
     struct wined3d_query *query = op->query;
+    struct wined3d_context *context;
 
     query->query_ops->query_issue(query, op->flags);
 
     InterlockedDecrement(&query->pending);
 
+    if (query->flush && (context = context_get_current()))
+        context->gl_info->gl_ops.gl.p_glFlush();
+
     return sizeof(*op);
 }
 
diff --git a/dlls/wined3d/query.c b/dlls/wined3d/query.c
index 2db6fa8c10..d6264cec01 100644
--- a/dlls/wined3d/query.c
+++ b/dlls/wined3d/query.c
@@ -351,8 +351,12 @@ HRESULT CDECL wined3d_query_get_data(struct wined3d_query *query,
         return WINED3DERR_INVALIDCALL;
     }
 
-    while (InterlockedCompareExchange(&query->pending, 0, 0));
+    if (flags & WINED3DGETDATA_FLUSH)
+        query->flush = TRUE;
+    if (InterlockedCompareExchange(&query->pending, 0, 0))
+        return S_FALSE;
 
+    query->flush = FALSE;
     if (!wined3d_cs_emit_query_poll(query->device->cs, query, flags))
         return S_FALSE;
 
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 747153e24f..69c3f9b48c 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -1507,6 +1507,7 @@ struct wined3d_query
     DWORD data_size;
     const struct wined3d_query_ops *query_ops;
     LONG pending;
+    BOOL flush;
 };
 
 union wined3d_gl_query_object
-- 
2.11.0

