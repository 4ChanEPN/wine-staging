From f468574b8d79c9c7ebe33ff29d7d73f26731aa1a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20D=C3=B6singer?= <stefan@codeweavers.com>
Date: Tue, 7 Feb 2017 15:44:57 +0100
Subject: wined3d: Run the cs asynchronously

---
 dlls/wined3d/cs.c              | 2 +-
 dlls/wined3d/query.c           | 6 ++++--
 dlls/wined3d/wined3d_private.h | 1 +
 3 files changed, 6 insertions(+), 3 deletions(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 1809f3f3484..36b07d1a54a 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -2762,7 +2762,7 @@ static void wined3d_cs_mt_submit_and_wait(struct wined3d_cs *cs)
 static const struct wined3d_cs_ops wined3d_cs_mt_ops =
 {
     wined3d_cs_mt_require_space,
-    wined3d_cs_mt_submit_and_wait,  /* FIXME */
+    wined3d_cs_mt_submit,
     wined3d_cs_mt_submit_and_wait,
 };
 
diff --git a/dlls/wined3d/query.c b/dlls/wined3d/query.c
index abb4a664c1a..b26350ff2b5 100644
--- a/dlls/wined3d/query.c
+++ b/dlls/wined3d/query.c
@@ -500,7 +500,7 @@ static void wined3d_occlusion_query_ops_issue(struct wined3d_query *query, DWORD
      * restart. */
     if (flags & WINED3DISSUE_BEGIN)
     {
-        if (query->state == QUERY_BUILDING)
+        if (oq->started)
         {
             if (oq->context->tid != GetCurrentThreadId())
             {
@@ -530,13 +530,14 @@ static void wined3d_occlusion_query_ops_issue(struct wined3d_query *query, DWORD
         checkGLcall("glBeginQuery()");
 
         context_release(context);
+        oq->started = TRUE;
     }
     if (flags & WINED3DISSUE_END)
     {
         /* MSDN says END on a non-building occlusion query returns an error,
          * but our tests show that it returns OK. But OpenGL doesn't like it,
          * so avoid generating an error. */
-        if (query->state == QUERY_BUILDING)
+        if (oq->started)
         {
             if (oq->context->tid != GetCurrentThreadId())
             {
@@ -552,6 +553,7 @@ static void wined3d_occlusion_query_ops_issue(struct wined3d_query *query, DWORD
                 context_release(context);
             }
         }
+        oq->started = FALSE;
     }
 }
 
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index c7c212f294f..7035d537604 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -1501,6 +1501,7 @@ struct wined3d_occlusion_query
     GLuint id;
     struct wined3d_context *context;
     UINT64 samples;
+    BOOL started;
 };
 
 struct wined3d_timestamp_query
-- 
2.11.0

