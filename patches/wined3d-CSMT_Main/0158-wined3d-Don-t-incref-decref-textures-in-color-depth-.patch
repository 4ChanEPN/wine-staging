From 9ceff8564c938a798238a8ff91ab75ad2659eb32 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20D=C3=B6singer?= <stefan@codeweavers.com>
Date: Thu, 28 Aug 2014 16:10:09 +0200
Subject: wined3d: Don't incref / decref textures in color / depth fill blits.

See comment in the code. The solution is not particularly nice. A better
approach may be to handle them in ddraw, where we have a permanent view
for the surface.
---
 dlls/wined3d/surface.c         | 59 +++++++++++++++++++++---------------------
 dlls/wined3d/view.c            | 20 --------------
 dlls/wined3d/wined3d_private.h |  1 -
 3 files changed, 30 insertions(+), 50 deletions(-)

diff --git a/dlls/wined3d/surface.c b/dlls/wined3d/surface.c
index bff8df5..aa844fc 100644
--- a/dlls/wined3d/surface.c
+++ b/dlls/wined3d/surface.c
@@ -911,8 +911,8 @@ static HRESULT wined3d_surface_depth_fill(struct wined3d_surface *surface, const
 {
     struct wined3d_resource *resource = &surface->container->resource;
     struct wined3d_device *device = resource->device;
-    struct wined3d_rendertarget_view_desc view_desc;
-    struct wined3d_rendertarget_view *view;
+    struct wined3d_rendertarget_view view;
+    struct wined3d_texture *texture = surface->container;
     const struct blit_shader *blitter;
     HRESULT hr;
 
@@ -923,19 +923,17 @@ static HRESULT wined3d_surface_depth_fill(struct wined3d_surface *surface, const
         return WINED3DERR_INVALIDCALL;
     }
 
-    view_desc.format_id = resource->format->id;
-    view_desc.u.texture.level_idx = surface->texture_level;
-    view_desc.u.texture.layer_idx = surface->texture_layer;
-    view_desc.u.texture.layer_count = 1;
-    if (FAILED(hr = wined3d_rendertarget_view_create(&view_desc,
-            resource, NULL, &wined3d_null_parent_ops, &view)))
-    {
-        ERR("Failed to create rendertarget view, hr %#x.\n", hr);
-        return hr;
-    }
+    view.resource = &surface->container->resource;
+    view.parent = NULL;
+    view.parent_ops = &wined3d_null_parent_ops;
+    view.format = surface->resource.format;
+    view.buffer_offset = 0;
+    view.width = surface->resource.width;
+    view.height = surface->resource.height;
+    view.depth = 1;
+    view.sub_resource_idx = surface->texture_layer * texture->level_count + surface->texture_level;
 
-    hr = blitter->depth_fill(device, view, rect, depth);
-    wined3d_rendertarget_view_decref_worker(view);
+    hr = blitter->depth_fill(device, &view, rect, depth);
 
     return hr;
 }
@@ -3235,8 +3233,8 @@ HRESULT surface_color_fill(struct wined3d_surface *s, const RECT *rect, const st
 {
     struct wined3d_resource *resource = &s->container->resource;
     struct wined3d_device *device = resource->device;
-    struct wined3d_rendertarget_view_desc view_desc;
-    struct wined3d_rendertarget_view *view;
+    struct wined3d_rendertarget_view view;
+    struct wined3d_texture *texture = s->container;
     const struct blit_shader *blitter;
     HRESULT hr;
 
@@ -3247,19 +3245,22 @@ HRESULT surface_color_fill(struct wined3d_surface *s, const RECT *rect, const st
         return WINED3DERR_INVALIDCALL;
     }
 
-    view_desc.format_id = resource->format->id;
-    view_desc.u.texture.level_idx = s->texture_level;
-    view_desc.u.texture.layer_idx = s->texture_layer;
-    view_desc.u.texture.layer_count = 1;
-    if (FAILED(hr = wined3d_rendertarget_view_create(&view_desc,
-            resource, NULL, &wined3d_null_parent_ops, &view)))
-    {
-        ERR("Failed to create rendertarget view, hr %#x.\n", hr);
-        return hr;
-    }
+    /* Can't incref / decref the resource here. This is executed inside the worker
+     * thread. Playing with the refcount here makes the worker thread visible to
+     * the client lib. Problems occur when the worker thread happens to hold the
+     * last reference and the resource destruction callbacks are called from the
+     * wrong thread. */
+    view.resource = &texture->resource;
+    view.parent = NULL;
+    view.parent_ops = &wined3d_null_parent_ops;
+    view.format = s->resource.format;
+    view.buffer_offset = 0;
+    view.width = s->resource.width;
+    view.height = s->resource.height;
+    view.depth = 1;
+    view.sub_resource_idx = s->texture_layer * texture->level_count + s->texture_level;
 
-    hr = blitter->color_fill(device, view, rect, color);
-    wined3d_rendertarget_view_decref_worker(view);
+    hr = blitter->color_fill(device, &view, rect, color);
 
     return hr;
 }
@@ -4056,7 +4057,7 @@ static HRESULT ffp_blit_color_fill(struct wined3d_device *device, struct wined3d
         const RECT *rect, const struct wined3d_color *color)
 {
     const RECT draw_rect = {0, 0, view->width, view->height};
-    struct wined3d_fb_state fb = {&view, NULL};
+    struct wined3d_fb_state fb = {&view, NULL, 1};
 
     device_clear_render_targets(device, 1, &fb, 1, rect, &draw_rect, WINED3DCLEAR_TARGET, color, 0.0f, 0);
 
diff --git a/dlls/wined3d/view.c b/dlls/wined3d/view.c
index e4694af..f2134f4 100644
--- a/dlls/wined3d/view.c
+++ b/dlls/wined3d/view.c
@@ -58,26 +58,6 @@ ULONG CDECL wined3d_rendertarget_view_decref(struct wined3d_rendertarget_view *v
     return refcount;
 }
 
-/* Ugly hack for ffp_blit_depth_fill that allows destroying a view from inside the
- * worker thread. */
-ULONG wined3d_rendertarget_view_decref_worker(struct wined3d_rendertarget_view *view)
-{
-    ULONG refcount = InterlockedDecrement(&view->refcount);
-
-    TRACE("%p decreasing refcount to %u.\n", view, refcount);
-
-    if (!refcount)
-    {
-        /* Call wined3d_object_destroyed() before releasing the resource,
-         * since releasing the resource may end up destroying the parent. */
-        view->parent_ops->wined3d_object_destroyed(view->parent);
-        wined3d_resource_decref(view->resource);
-        wined3d_rendertarget_view_destroy(view);
-    }
-
-    return refcount;
-}
-
 void * CDECL wined3d_rendertarget_view_get_parent(const struct wined3d_rendertarget_view *view)
 {
     TRACE("view %p.\n", view);
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 929e7c7..0e0c8fa 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -3063,7 +3063,6 @@ static inline struct wined3d_surface *wined3d_rendertarget_view_get_surface(
     return surface_from_resource(resource);
 }
 
-ULONG wined3d_rendertarget_view_decref_worker(struct wined3d_rendertarget_view *view) DECLSPEC_HIDDEN;
 void wined3d_rendertarget_view_destroy(struct wined3d_rendertarget_view *view) DECLSPEC_HIDDEN;
 
 struct wined3d_shader_resource_view
-- 
2.7.0

