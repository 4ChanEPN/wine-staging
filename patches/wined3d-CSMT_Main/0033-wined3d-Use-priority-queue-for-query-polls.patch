From 5325c69d1b31fd1cd22638c995a1684f1f05e823 Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Wed, 8 Feb 2017 00:40:59 +0100
Subject: wined3d: Use priority queue for query polls.

---
 dlls/wined3d/cs.c              | 6 +++++-
 dlls/wined3d/query.c           | 3 +++
 dlls/wined3d/wined3d_private.h | 1 +
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 3e7defdeb1b..a5a6fc0fa4a 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -1694,6 +1694,8 @@ static UINT wined3d_cs_exec_query_issue(struct wined3d_cs *cs, const void *data)
 
     query->query_ops->query_issue(query, op->flags);
 
+    InterlockedDecrement(&query->pending);
+
     return sizeof(*op);
 }
 
@@ -1706,6 +1708,8 @@ void wined3d_cs_emit_query_issue(struct wined3d_cs *cs, struct wined3d_query *qu
     op->query = query;
     op->flags = flags;
 
+    InterlockedIncrement(&query->pending);
+
     cs->ops->submit(cs);
 }
 
@@ -1724,7 +1728,7 @@ BOOL wined3d_cs_emit_query_poll(struct wined3d_cs *cs, struct wined3d_query *que
     struct wined3d_cs_query_poll *op;
     BOOL ret;
 
-    op = cs->ops->require_space(cs, sizeof(*op), 0);
+    op = cs->ops->require_space(cs, sizeof(*op), 1);
     op->opcode = WINED3D_CS_OP_QUERY_POLL;
     op->query = query;
     op->flags = flags;
diff --git a/dlls/wined3d/query.c b/dlls/wined3d/query.c
index 70603367894..2db6fa8c10d 100644
--- a/dlls/wined3d/query.c
+++ b/dlls/wined3d/query.c
@@ -37,6 +37,7 @@ static void wined3d_query_init(struct wined3d_query *query, struct wined3d_devic
     query->data = data;
     query->data_size = data_size;
     query->query_ops = query_ops;
+    query->pending = 0;
 }
 
 static struct wined3d_event_query *wined3d_event_query_from_query(struct wined3d_query *query)
@@ -350,6 +351,8 @@ HRESULT CDECL wined3d_query_get_data(struct wined3d_query *query,
         return WINED3DERR_INVALIDCALL;
     }
 
+    while (InterlockedCompareExchange(&query->pending, 0, 0));
+
     if (!wined3d_cs_emit_query_poll(query->device->cs, query, flags))
         return S_FALSE;
 
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 43b3146f6f8..ba371f13d8d 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -1500,6 +1500,7 @@ struct wined3d_query
     const void *data;
     DWORD data_size;
     const struct wined3d_query_ops *query_ops;
+    LONG pending;
 };
 
 union wined3d_gl_query_object
-- 
2.11.0

