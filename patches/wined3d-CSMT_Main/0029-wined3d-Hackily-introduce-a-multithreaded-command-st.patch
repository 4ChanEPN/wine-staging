From 14c03f8d908801366664836b6a4b4191cf2eacb4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Stefan=20D=C3=B6singer?= <stefan@codeweavers.com>
Date: Tue, 1 Oct 2013 14:31:56 +0200
Subject: wined3d: Hackily introduce a multithreaded command stream

---
 dlls/wined3d/context.c         |   3 +
 dlls/wined3d/cs.c              | 447 +++++++++++++++++++++++++++++++++++------
 dlls/wined3d/device.c          |   2 +-
 dlls/wined3d/wined3d_main.c    |  10 +
 dlls/wined3d/wined3d_private.h |  33 ++-
 5 files changed, 433 insertions(+), 62 deletions(-)

diff --git a/dlls/wined3d/context.c b/dlls/wined3d/context.c
index 511b1bd4216..61c338a7698 100644
--- a/dlls/wined3d/context.c
+++ b/dlls/wined3d/context.c
@@ -3746,6 +3746,9 @@ struct wined3d_context *context_acquire(const struct wined3d_device *device,
 
     TRACE("device %p, texture %p, sub_resource_idx %u.\n", device, texture, sub_resource_idx);
 
+    if (wined3d_settings.cs_multithreaded && device->cs->thread_id != GetCurrentThreadId())
+        FIXME("Acquiring a GL context from outside the CS thread.\n");
+
     if (current_context && current_context->destroyed)
         current_context = NULL;
 
diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index f888c013127..0c751c3176d 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -18,6 +18,7 @@
 
 #include "config.h"
 #include "wine/port.h"
+#include <assert.h>
 #include "wined3d_private.h"
 
 WINE_DEFAULT_DEBUG_CHANNEL(d3d);
@@ -78,6 +79,7 @@ enum wined3d_cs_op
     WINED3D_CS_OP_TEXTURE_ADD_DIRTY_REGION,
     WINED3D_CS_OP_BUFFER_COPY,
     WINED3D_CS_OP_MAP_VERTEX_BUFFERS,
+    WINED3D_CS_OP_STOP,
 };
 
 struct wined3d_cs_sync
@@ -470,8 +472,14 @@ struct wined3d_cs_map_vertex_buffers
     struct wined3d_stream_info *stream_info;
 };
 
-static void wined3d_cs_exec_sync(struct wined3d_cs *cs, const void *data)
+struct wined3d_cs_stop
 {
+    enum wined3d_cs_op opcode;
+};
+
+static UINT wined3d_cs_exec_sync(struct wined3d_cs *cs, const void *data)
+{
+    return sizeof(struct wined3d_cs_sync);
 }
 
 void wined3d_cs_emit_sync(struct wined3d_cs *cs)
@@ -484,12 +492,14 @@ void wined3d_cs_emit_sync(struct wined3d_cs *cs)
     cs->ops->submit_and_wait(cs);
 }
 
-static void wined3d_cs_exec_glfinish(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_glfinish(struct wined3d_cs *cs, const void *data)
 {
     struct wined3d_context *context = context_get_current();
 
     if (context)
         context->gl_info->gl_ops.gl.p_glFinish();
+
+    return sizeof(struct wined3d_cs_glfinish);
 }
 
 void wined3d_cs_emit_glfinish(struct wined3d_cs *cs)
@@ -502,7 +512,7 @@ void wined3d_cs_emit_glfinish(struct wined3d_cs *cs)
     cs->ops->submit_and_wait(cs);
 }
 
-static void wined3d_cs_exec_present(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_present(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_present *op = data;
     struct wined3d_swapchain *swapchain;
@@ -521,6 +531,8 @@ static void wined3d_cs_exec_present(struct wined3d_cs *cs, const void *data)
     {
         wined3d_resource_release(&swapchain->back_buffers[i]->resource);
     }
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_present(struct wined3d_cs *cs, struct wined3d_swapchain *swapchain,
@@ -560,13 +572,14 @@ void wined3d_cs_emit_present(struct wined3d_cs *cs, struct wined3d_swapchain *sw
         pending = InterlockedCompareExchange(&cs->pending_presents, 0, 0);
 }
 
-static void wined3d_cs_exec_clear(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_clear(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_state *state = &cs->state;
     const struct wined3d_cs_clear *op = data;
     struct wined3d_device *device;
     unsigned int i;
     RECT draw_rect;
+    size_t size = FIELD_OFFSET(struct wined3d_cs_clear, rects[op->rect_count]);
 
     device = cs->device;
     wined3d_get_draw_rect(state, &draw_rect);
@@ -584,6 +597,8 @@ static void wined3d_cs_exec_clear(struct wined3d_cs *cs, const void *data)
     }
     if (op->flags & (WINED3DCLEAR_ZBUFFER | WINED3DCLEAR_STENCIL))
         wined3d_resource_release(state->fb->depth_stencil->resource);
+
+    return size;
 }
 
 void wined3d_cs_emit_clear(struct wined3d_cs *cs, DWORD rect_count, const RECT *rects,
@@ -722,7 +737,7 @@ static void release_unordered_access_resources(const struct wined3d_shader *shad
     }
 }
 
-static void wined3d_cs_exec_dispatch(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_dispatch(struct wined3d_cs *cs, const void *data)
 {
     struct wined3d_state *state = &cs->state;
     const struct wined3d_cs_dispatch *op = data;
@@ -733,6 +748,8 @@ static void wined3d_cs_exec_dispatch(struct wined3d_cs *cs, const void *data)
     release_shader_resources(state, 1u << WINED3D_SHADER_TYPE_COMPUTE);
     release_unordered_access_resources(state->shader[WINED3D_SHADER_TYPE_COMPUTE],
             state->unordered_access_view[WINED3D_PIPELINE_COMPUTE]);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_dispatch(struct wined3d_cs *cs,
@@ -754,7 +771,7 @@ void wined3d_cs_emit_dispatch(struct wined3d_cs *cs,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_draw(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_draw(struct wined3d_cs *cs, const void *data)
 {
     struct wined3d_state *state = &cs->state;
     const struct wined3d_cs_draw *op = data;
@@ -799,6 +816,8 @@ static void wined3d_cs_exec_draw(struct wined3d_cs *cs, const void *data)
     release_shader_resources(state, ~(1u << WINED3D_SHADER_TYPE_COMPUTE));
     release_unordered_access_resources(state->shader[WINED3D_SHADER_TYPE_PIXEL],
             state->unordered_access_view[WINED3D_PIPELINE_GRAPHICS]);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_draw(struct wined3d_cs *cs, GLenum primitive_type, int base_vertex_idx, unsigned int start_idx,
@@ -844,12 +863,14 @@ void wined3d_cs_emit_draw(struct wined3d_cs *cs, GLenum primitive_type, int base
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_predication(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_predication(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_predication *op = data;
 
     cs->state.predicate = op->predicate;
     cs->state.predicate_value = op->value;
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_predication(struct wined3d_cs *cs, struct wined3d_query *predicate, BOOL value)
@@ -864,12 +885,14 @@ void wined3d_cs_emit_set_predication(struct wined3d_cs *cs, struct wined3d_query
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_viewport(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_viewport(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_viewport *op = data;
 
     cs->state.viewport = op->viewport;
     device_invalidate_state(cs->device, STATE_VIEWPORT);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_viewport(struct wined3d_cs *cs, const struct wined3d_viewport *viewport)
@@ -883,12 +906,14 @@ void wined3d_cs_emit_set_viewport(struct wined3d_cs *cs, const struct wined3d_vi
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_scissor_rect(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_scissor_rect(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_scissor_rect *op = data;
 
     cs->state.scissor_rect = op->rect;
     device_invalidate_state(cs->device, STATE_SCISSORRECT);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_scissor_rect(struct wined3d_cs *cs, const RECT *rect)
@@ -902,12 +927,14 @@ void wined3d_cs_emit_set_scissor_rect(struct wined3d_cs *cs, const RECT *rect)
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_rendertarget_view(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_rendertarget_view(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_rendertarget_view *op = data;
 
     cs->state.fb->render_targets[op->view_idx] = op->view;
     device_invalidate_state(cs->device, STATE_FRAMEBUFFER);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_rendertarget_view(struct wined3d_cs *cs, unsigned int view_idx,
@@ -923,7 +950,7 @@ void wined3d_cs_emit_set_rendertarget_view(struct wined3d_cs *cs, unsigned int v
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_depth_stencil_view(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_depth_stencil_view(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_depth_stencil_view *op = data;
     struct wined3d_device *device = cs->device;
@@ -958,6 +985,8 @@ static void wined3d_cs_exec_set_depth_stencil_view(struct wined3d_cs *cs, const
     }
 
     device_invalidate_state(device, STATE_FRAMEBUFFER);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_depth_stencil_view(struct wined3d_cs *cs, struct wined3d_rendertarget_view *view)
@@ -971,12 +1000,14 @@ void wined3d_cs_emit_set_depth_stencil_view(struct wined3d_cs *cs, struct wined3
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_vertex_declaration(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_vertex_declaration(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_vertex_declaration *op = data;
 
     cs->state.vertex_declaration = op->declaration;
     device_invalidate_state(cs->device, STATE_VDECL);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_vertex_declaration(struct wined3d_cs *cs, struct wined3d_vertex_declaration *declaration)
@@ -990,7 +1021,7 @@ void wined3d_cs_emit_set_vertex_declaration(struct wined3d_cs *cs, struct wined3
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_stream_source(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_stream_source(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_stream_source *op = data;
     struct wined3d_stream_state *stream;
@@ -1008,6 +1039,8 @@ static void wined3d_cs_exec_set_stream_source(struct wined3d_cs *cs, const void
         InterlockedDecrement(&prev->resource.bind_count);
 
     device_invalidate_state(cs->device, STATE_STREAMSRC);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_stream_source(struct wined3d_cs *cs, UINT stream_idx,
@@ -1025,7 +1058,7 @@ void wined3d_cs_emit_set_stream_source(struct wined3d_cs *cs, UINT stream_idx,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_stream_source_freq(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_stream_source_freq(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_stream_source_freq *op = data;
     struct wined3d_stream_state *stream;
@@ -1035,6 +1068,8 @@ static void wined3d_cs_exec_set_stream_source_freq(struct wined3d_cs *cs, const
     stream->flags = op->flags;
 
     device_invalidate_state(cs->device, STATE_STREAMSRC);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_stream_source_freq(struct wined3d_cs *cs, UINT stream_idx, UINT frequency, UINT flags)
@@ -1050,7 +1085,7 @@ void wined3d_cs_emit_set_stream_source_freq(struct wined3d_cs *cs, UINT stream_i
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_stream_output(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_stream_output(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_stream_output *op = data;
     struct wined3d_stream_output *stream;
@@ -1065,6 +1100,8 @@ static void wined3d_cs_exec_set_stream_output(struct wined3d_cs *cs, const void
         InterlockedIncrement(&op->buffer->resource.bind_count);
     if (prev)
         InterlockedDecrement(&prev->resource.bind_count);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_stream_output(struct wined3d_cs *cs, UINT stream_idx,
@@ -1081,7 +1118,7 @@ void wined3d_cs_emit_set_stream_output(struct wined3d_cs *cs, UINT stream_idx,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_index_buffer(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_index_buffer(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_index_buffer *op = data;
     struct wined3d_buffer *prev;
@@ -1097,6 +1134,8 @@ static void wined3d_cs_exec_set_index_buffer(struct wined3d_cs *cs, const void *
         InterlockedDecrement(&prev->resource.bind_count);
 
     device_invalidate_state(cs->device, STATE_INDEXBUFFER);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_index_buffer(struct wined3d_cs *cs, struct wined3d_buffer *buffer,
@@ -1113,7 +1152,7 @@ void wined3d_cs_emit_set_index_buffer(struct wined3d_cs *cs, struct wined3d_buff
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_constant_buffer(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_constant_buffer(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_constant_buffer *op = data;
     struct wined3d_buffer *prev;
@@ -1127,6 +1166,7 @@ static void wined3d_cs_exec_set_constant_buffer(struct wined3d_cs *cs, const voi
         InterlockedDecrement(&prev->resource.bind_count);
 
     device_invalidate_state(cs->device, STATE_CONSTANT_BUFFER(op->type));
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_constant_buffer(struct wined3d_cs *cs, enum wined3d_shader_type type,
@@ -1143,7 +1183,7 @@ void wined3d_cs_emit_set_constant_buffer(struct wined3d_cs *cs, enum wined3d_sha
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_texture(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_texture(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_gl_info *gl_info = &cs->device->adapter->gl_info;
     const struct wined3d_d3d_info *d3d_info = &cs->device->adapter->d3d_info;
@@ -1220,6 +1260,8 @@ static void wined3d_cs_exec_set_texture(struct wined3d_cs *cs, const void *data)
 
     if (new_use_color_key)
         device_invalidate_state(cs->device, STATE_COLOR_KEY);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_texture(struct wined3d_cs *cs, UINT stage, struct wined3d_texture *texture)
@@ -1234,7 +1276,7 @@ void wined3d_cs_emit_set_texture(struct wined3d_cs *cs, UINT stage, struct wined
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_shader_resource_view(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_shader_resource_view(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_shader_resource_view *op = data;
     struct wined3d_shader_resource_view *prev;
@@ -1251,6 +1293,8 @@ static void wined3d_cs_exec_set_shader_resource_view(struct wined3d_cs *cs, cons
         device_invalidate_state(cs->device, STATE_GRAPHICS_SHADER_RESOURCE_BINDING);
     else
         device_invalidate_state(cs->device, STATE_COMPUTE_SHADER_RESOURCE_BINDING);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_shader_resource_view(struct wined3d_cs *cs, enum wined3d_shader_type type,
@@ -1267,7 +1311,7 @@ void wined3d_cs_emit_set_shader_resource_view(struct wined3d_cs *cs, enum wined3
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_unordered_access_view(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_unordered_access_view(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_unordered_access_view *op = data;
     struct wined3d_unordered_access_view *prev;
@@ -1281,6 +1325,8 @@ static void wined3d_cs_exec_set_unordered_access_view(struct wined3d_cs *cs, con
         InterlockedDecrement(&prev->resource->bind_count);
 
     device_invalidate_state(cs->device, STATE_UNORDERED_ACCESS_VIEW_BINDING(op->pipeline));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_unordered_access_view(struct wined3d_cs *cs, enum wined3d_pipeline pipeline,
@@ -1297,7 +1343,7 @@ void wined3d_cs_emit_set_unordered_access_view(struct wined3d_cs *cs, enum wined
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_sampler(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_sampler(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_sampler *op = data;
 
@@ -1306,6 +1352,8 @@ static void wined3d_cs_exec_set_sampler(struct wined3d_cs *cs, const void *data)
         device_invalidate_state(cs->device, STATE_GRAPHICS_SHADER_RESOURCE_BINDING);
     else
         device_invalidate_state(cs->device, STATE_COMPUTE_SHADER_RESOURCE_BINDING);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_sampler(struct wined3d_cs *cs, enum wined3d_shader_type type,
@@ -1322,7 +1370,7 @@ void wined3d_cs_emit_set_sampler(struct wined3d_cs *cs, enum wined3d_shader_type
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_shader(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_shader(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_shader *op = data;
 
@@ -1332,6 +1380,8 @@ static void wined3d_cs_exec_set_shader(struct wined3d_cs *cs, const void *data)
         device_invalidate_state(cs->device, STATE_GRAPHICS_SHADER_RESOURCE_BINDING);
     else
         device_invalidate_state(cs->device, STATE_COMPUTE_SHADER_RESOURCE_BINDING);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_shader(struct wined3d_cs *cs, enum wined3d_shader_type type, struct wined3d_shader *shader)
@@ -1346,12 +1396,14 @@ void wined3d_cs_emit_set_shader(struct wined3d_cs *cs, enum wined3d_shader_type
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_rasterizer_state(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_rasterizer_state(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_rasterizer_state *op = data;
 
     cs->state.rasterizer_state = op->state;
     device_invalidate_state(cs->device, STATE_FRONTFACE);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_rasterizer_state(struct wined3d_cs *cs,
@@ -1366,12 +1418,14 @@ void wined3d_cs_emit_set_rasterizer_state(struct wined3d_cs *cs,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_render_state(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_render_state(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_render_state *op = data;
 
     cs->state.render_states[op->state] = op->value;
     device_invalidate_state(cs->device, STATE_RENDER(op->state));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_render_state(struct wined3d_cs *cs, enum wined3d_render_state state, DWORD value)
@@ -1386,12 +1440,14 @@ void wined3d_cs_emit_set_render_state(struct wined3d_cs *cs, enum wined3d_render
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_texture_state(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_texture_state(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_texture_state *op = data;
 
     cs->state.texture_states[op->stage][op->state] = op->value;
     device_invalidate_state(cs->device, STATE_TEXTURESTAGE(op->stage, op->state));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_texture_state(struct wined3d_cs *cs, UINT stage,
@@ -1408,12 +1464,14 @@ void wined3d_cs_emit_set_texture_state(struct wined3d_cs *cs, UINT stage,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_sampler_state(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_sampler_state(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_sampler_state *op = data;
 
     cs->state.sampler_states[op->sampler_idx][op->state] = op->value;
     device_invalidate_state(cs->device, STATE_SAMPLER(op->sampler_idx));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_sampler_state(struct wined3d_cs *cs, UINT sampler_idx,
@@ -1430,13 +1488,15 @@ void wined3d_cs_emit_set_sampler_state(struct wined3d_cs *cs, UINT sampler_idx,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_transform(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_transform(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_transform *op = data;
 
     cs->state.transforms[op->state] = op->matrix;
     if (op->state < WINED3D_TS_WORLD_MATRIX(cs->device->adapter->d3d_info.limits.ffp_vertex_blend_matrices))
         device_invalidate_state(cs->device, STATE_TRANSFORM(op->state));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_transform(struct wined3d_cs *cs, enum wined3d_transform_state state,
@@ -1452,12 +1512,14 @@ void wined3d_cs_emit_set_transform(struct wined3d_cs *cs, enum wined3d_transform
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_clip_plane(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_clip_plane(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_clip_plane *op = data;
 
     cs->state.clip_planes[op->plane_idx] = op->plane;
     device_invalidate_state(cs->device, STATE_CLIPPLANE(op->plane_idx));
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_clip_plane(struct wined3d_cs *cs, UINT plane_idx, const struct wined3d_vec4 *plane)
@@ -1472,7 +1534,7 @@ void wined3d_cs_emit_set_clip_plane(struct wined3d_cs *cs, UINT plane_idx, const
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_color_key(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_color_key(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_color_key *op = data;
     struct wined3d_texture *texture = op->texture;
@@ -1533,6 +1595,8 @@ static void wined3d_cs_exec_set_color_key(struct wined3d_cs *cs, const void *dat
                 break;
         }
     }
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_color_key(struct wined3d_cs *cs, struct wined3d_texture *texture,
@@ -1555,12 +1619,14 @@ void wined3d_cs_emit_set_color_key(struct wined3d_cs *cs, struct wined3d_texture
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_material(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_material(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_material *op = data;
 
     cs->state.material = op->material;
     device_invalidate_state(cs->device, STATE_MATERIAL);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_material(struct wined3d_cs *cs, const struct wined3d_material *material)
@@ -1574,7 +1640,7 @@ void wined3d_cs_emit_set_material(struct wined3d_cs *cs, const struct wined3d_ma
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_light(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_light(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_light *op = data;
     struct wined3d_light_info *light_info;
@@ -1588,7 +1654,7 @@ static void wined3d_cs_exec_set_light(struct wined3d_cs *cs, const void *data)
         if (!(light_info = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sizeof(*light_info))))
         {
             ERR("Failed to allocate light info.\n");
-            return;
+            return sizeof(*op);;
         }
 
         hash_idx = LIGHTMAP_HASHFUNC(light_idx);
@@ -1609,6 +1675,8 @@ static void wined3d_cs_exec_set_light(struct wined3d_cs *cs, const void *data)
     light_info->direction = op->light.direction;
     light_info->exponent = op->light.exponent;
     light_info->cutoff = op->light.cutoff;
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_light(struct wined3d_cs *cs, const struct wined3d_light_info *light)
@@ -1622,7 +1690,7 @@ void wined3d_cs_emit_set_light(struct wined3d_cs *cs, const struct wined3d_light
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_set_light_enable(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_set_light_enable(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_set_light_enable *op = data;
     struct wined3d_device *device = cs->device;
@@ -1632,7 +1700,7 @@ static void wined3d_cs_exec_set_light_enable(struct wined3d_cs *cs, const void *
     if (!(light_info = wined3d_state_get_light(&cs->state, op->idx)))
     {
         ERR("Light doesn't exist.\n");
-        return;
+        return sizeof(*op);
     }
 
     prev_idx = light_info->glIndex;
@@ -1642,6 +1710,8 @@ static void wined3d_cs_exec_set_light_enable(struct wined3d_cs *cs, const void *
         device_invalidate_state(device, STATE_LIGHT_TYPE);
         device_invalidate_state(device, STATE_ACTIVELIGHT(op->enable ? light_info->glIndex : prev_idx));
     }
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_set_light_enable(struct wined3d_cs *cs, unsigned int idx, BOOL enable)
@@ -1656,7 +1726,7 @@ void wined3d_cs_emit_set_light_enable(struct wined3d_cs *cs, unsigned int idx, B
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_reset_state(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_reset_state(struct wined3d_cs *cs, const void *data)
 {
     struct wined3d_adapter *adapter = cs->device->adapter;
 
@@ -1664,6 +1734,8 @@ static void wined3d_cs_exec_reset_state(struct wined3d_cs *cs, const void *data)
     memset(&cs->state, 0, sizeof(cs->state));
     state_init(&cs->state, &cs->fb, &adapter->gl_info, &adapter->d3d_info,
             WINED3D_STATE_NO_REF | WINED3D_STATE_INIT_DEFAULT);
+
+    return sizeof(struct wined3d_cs_reset_state);
 }
 
 void wined3d_cs_emit_reset_state(struct wined3d_cs *cs)
@@ -1676,11 +1748,13 @@ void wined3d_cs_emit_reset_state(struct wined3d_cs *cs)
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_callback(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_callback(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_callback *op = data;
 
     op->callback(op->object);
+
+    return sizeof(*op);
 }
 
 static void wined3d_cs_emit_callback(struct wined3d_cs *cs, void (*callback)(void *object), void *object)
@@ -1705,12 +1779,14 @@ void wined3d_cs_init_object(struct wined3d_cs *cs, void (*callback)(void *object
     wined3d_cs_emit_callback(cs, callback, object);
 }
 
-static void wined3d_cs_exec_query_issue(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_query_issue(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_query_issue *op = data;
     struct wined3d_query *query = op->query;
 
     query->query_ops->query_issue(query, op->flags);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_query_issue(struct wined3d_cs *cs, struct wined3d_query *query, DWORD flags)
@@ -1725,12 +1801,14 @@ void wined3d_cs_emit_query_issue(struct wined3d_cs *cs, struct wined3d_query *qu
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_query_poll(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_query_poll(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_query_poll *op = data;
     struct wined3d_query *query = op->query;
 
     *op->ret = query->query_ops->query_poll(query, op->flags);
+
+    return sizeof(*op);
 }
 
 BOOL wined3d_cs_emit_query_poll(struct wined3d_cs *cs, struct wined3d_query *query, DWORD flags)
@@ -1749,13 +1827,15 @@ BOOL wined3d_cs_emit_query_poll(struct wined3d_cs *cs, struct wined3d_query *que
     return ret;
 }
 
-static void wined3d_cs_exec_preload_resource(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_preload_resource(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_preload_resource *op = data;
     struct wined3d_resource *resource = op->resource;
 
     resource->resource_ops->resource_preload(resource);
     wined3d_resource_release(resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_preload_resource(struct wined3d_cs *cs, struct wined3d_resource *resource)
@@ -1771,13 +1851,15 @@ void wined3d_cs_emit_preload_resource(struct wined3d_cs *cs, struct wined3d_reso
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_unload_resource(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_unload_resource(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_unload_resource *op = data;
     struct wined3d_resource *resource = op->resource;
 
     resource->resource_ops->resource_unload(resource);
     wined3d_resource_release(resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_unload_resource(struct wined3d_cs *cs, struct wined3d_resource *resource)
@@ -1793,13 +1875,15 @@ void wined3d_cs_emit_unload_resource(struct wined3d_cs *cs, struct wined3d_resou
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_map(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_map(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_map *op = data;
     struct wined3d_resource *resource = op->resource;
 
     *op->hr = resource->resource_ops->resource_sub_resource_map(resource,
             op->sub_resource_idx, op->map_desc, op->box, op->flags);
+
+    return sizeof(*op);
 }
 
 HRESULT wined3d_cs_map(struct wined3d_cs *cs, struct wined3d_resource *resource, unsigned int sub_resource_idx,
@@ -1822,12 +1906,14 @@ HRESULT wined3d_cs_map(struct wined3d_cs *cs, struct wined3d_resource *resource,
     return hr;
 }
 
-static void wined3d_cs_exec_unmap(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_unmap(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_unmap *op = data;
     struct wined3d_resource *resource = op->resource;
 
     *op->hr = resource->resource_ops->resource_sub_resource_unmap(resource, op->sub_resource_idx);
+
+    return sizeof(*op);
 }
 
 HRESULT wined3d_cs_unmap(struct wined3d_cs *cs, struct wined3d_resource *resource, unsigned int sub_resource_idx)
@@ -1868,10 +1954,11 @@ push_constant_info[] =
     {FIELD_OFFSET(struct wined3d_state, ps_consts_b), sizeof(BOOL),                 WINED3D_SHADER_CONST_PS_B},
 };
 
-static void wined3d_cs_exec_push_constants(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_push_constants(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_push_constants *op = data;
     struct wined3d_device *device = cs->device;
+    size_t size = FIELD_OFFSET(struct wined3d_cs_push_constants, constants[op->count * push_constant_info[op->p].size]);
     unsigned int context_count;
     unsigned int i;
     size_t offset;
@@ -1887,6 +1974,8 @@ static void wined3d_cs_exec_push_constants(struct wined3d_cs *cs, const void *da
     {
         device->contexts[i]->constant_update_mask |= push_constant_info[op->p].mask;
     }
+
+    return size;
 }
 
 void wined3d_cs_emit_push_constants(struct wined3d_cs *cs, enum wined3d_push_constants p,
@@ -1904,7 +1993,7 @@ void wined3d_cs_emit_push_constants(struct wined3d_cs *cs, enum wined3d_push_con
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_blt(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_blt(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_blt *op = data;
 
@@ -1915,6 +2004,8 @@ static void wined3d_cs_exec_blt(struct wined3d_cs *cs, const void *data)
     wined3d_resource_release(&op->dst_surface->container->resource);
     if (op->src_surface && op->src_surface != op->dst_surface)
         wined3d_resource_release(&op->src_surface->container->resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_blt(struct wined3d_cs *cs, struct wined3d_surface *dst_surface,
@@ -1942,7 +2033,7 @@ void wined3d_cs_emit_blt(struct wined3d_cs *cs, struct wined3d_surface *dst_surf
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_clear_rtv(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_clear_rtv(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_clear_rtv *op = data;
     struct wined3d_device *device = cs->device;
@@ -1953,6 +2044,8 @@ static void wined3d_cs_exec_clear_rtv(struct wined3d_cs *cs, const void *data)
         op->blitter->depth_fill(device, op->view, &op->rect, op->flags, op->depth, op->stencil);
 
     wined3d_resource_release(op->view->resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_clear_rtv(struct wined3d_cs *cs, struct wined3d_rendertarget_view *view,
@@ -1977,7 +2070,7 @@ void wined3d_cs_emit_clear_rtv(struct wined3d_cs *cs, struct wined3d_rendertarge
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_update_texture(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_update_texture(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_update_texture *op = data;
     struct wined3d_context *context;
@@ -1988,6 +2081,8 @@ static void wined3d_cs_exec_update_texture(struct wined3d_cs *cs, const void *da
 
     wined3d_resource_release(&op->src->resource);
     wined3d_resource_release(&op->dst->resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_update_texture(struct wined3d_cs *cs, struct wined3d_texture *src,
@@ -2006,7 +2101,7 @@ void wined3d_cs_emit_update_texture(struct wined3d_cs *cs, struct wined3d_textur
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_update_sub_resource *op = data;
     struct wined3d_const_bo_address addr;
@@ -2022,7 +2117,7 @@ static void wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const voi
         if (FAILED(hr = wined3d_buffer_upload_data(buffer, op->box, op->data)))
             WARN("Failed to update buffer data, hr %#x.\n", hr);
 
-        return;
+        return sizeof(*op);
     }
 
     texture = wined3d_texture_from_resource(op->resource);
@@ -2051,6 +2146,8 @@ static void wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const voi
 
     wined3d_texture_validate_location(texture, op->sub_resource_idx, WINED3D_LOCATION_TEXTURE_RGB);
     wined3d_texture_invalidate_location(texture, op->sub_resource_idx, ~WINED3D_LOCATION_TEXTURE_RGB);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_update_sub_resource(struct wined3d_cs *cs, struct wined3d_resource *resource,
@@ -2073,11 +2170,13 @@ void wined3d_cs_emit_update_sub_resource(struct wined3d_cs *cs, struct wined3d_r
     cs->ops->submit_and_wait(cs);
 }
 
-static void wined3d_cs_exec_get_dc(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_get_dc(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_get_release_dc *op = data;
 
     *op->hr = wined3d_texture_get_dc_cs(op->texture, op->sub_resource_idx);
+
+    return sizeof(*op);
 }
 
 HRESULT wined3d_cs_emit_get_dc(struct wined3d_cs *cs, struct wined3d_texture *texture,
@@ -2097,11 +2196,13 @@ HRESULT wined3d_cs_emit_get_dc(struct wined3d_cs *cs, struct wined3d_texture *te
     return hr;
 }
 
-static void wined3d_cs_exec_release_dc(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_release_dc(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_get_release_dc *op = data;
 
     *op->hr = wined3d_texture_release_dc_cs(op->texture, op->sub_resource_idx);
+
+    return sizeof(*op);
 }
 
 HRESULT wined3d_cs_emit_release_dc(struct wined3d_cs *cs, struct wined3d_texture *texture,
@@ -2121,11 +2222,13 @@ HRESULT wined3d_cs_emit_release_dc(struct wined3d_cs *cs, struct wined3d_texture
     return hr;
 }
 
-static void wined3d_cs_exec_create_swapchain_context(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_create_swapchain_context(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_create_swapchain_context *op = data;
 
     *op->hr = swapchain_create_context_cs(cs->device, op->swapchain);
+
+    return sizeof(*op);
 }
 
 HRESULT wined3d_cs_emit_create_swapchain_context(struct wined3d_cs *cs, struct wined3d_swapchain *swapchain)
@@ -2143,11 +2246,13 @@ HRESULT wined3d_cs_emit_create_swapchain_context(struct wined3d_cs *cs, struct w
     return hr;
 }
 
-static void wined3d_cs_exec_update_swap_interval(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_update_swap_interval(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_update_swap_interval *op = data;
 
     swapchain_update_swap_interval(op->swapchain);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_update_swap_interval(struct wined3d_cs *cs, struct wined3d_swapchain *swapchain)
@@ -2161,7 +2266,7 @@ void wined3d_cs_emit_update_swap_interval(struct wined3d_cs *cs, struct wined3d_
     cs->ops->submit_and_wait(cs);
 }
 
-static void wined3d_cs_exec_texture_add_dirty_region(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_texture_add_dirty_region(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_texture_add_dirty_region *op = data;
     struct wined3d_texture *texture = op->texture;
@@ -2179,6 +2284,8 @@ static void wined3d_cs_exec_texture_add_dirty_region(struct wined3d_cs *cs, cons
     context_release(context);
 
     wined3d_resource_release(&texture->resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_texture_add_dirty_region(struct wined3d_cs *cs,
@@ -2200,7 +2307,7 @@ void wined3d_cs_emit_texture_add_dirty_region(struct wined3d_cs *cs,
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_buffer_copy(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_buffer_copy(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_buffer_copy *op = data;
     HRESULT hr;
@@ -2210,6 +2317,8 @@ static void wined3d_cs_exec_buffer_copy(struct wined3d_cs *cs, const void *data)
 
     wined3d_resource_release(&op->dst_buffer->resource);
     wined3d_resource_release(&op->src_buffer->resource);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_buffer_copy(struct wined3d_cs *cs, struct wined3d_buffer *dst_buffer,
@@ -2232,7 +2341,7 @@ void wined3d_cs_emit_buffer_copy(struct wined3d_cs *cs, struct wined3d_buffer *d
     cs->ops->submit(cs);
 }
 
-static void wined3d_cs_exec_map_vertex_buffers(struct wined3d_cs *cs, const void *data)
+static UINT wined3d_cs_exec_map_vertex_buffers(struct wined3d_cs *cs, const void *data)
 {
     const struct wined3d_cs_map_vertex_buffers *op = data;
     struct wined3d_state *state = &cs->device->state;
@@ -2279,6 +2388,8 @@ static void wined3d_cs_exec_map_vertex_buffers(struct wined3d_cs *cs, const void
     }
 
     context_release(context);
+
+    return sizeof(*op);
 }
 
 void wined3d_cs_emit_map_vertex_buffers(struct wined3d_cs *cs, UINT src_start_idx,
@@ -2294,7 +2405,7 @@ void wined3d_cs_emit_map_vertex_buffers(struct wined3d_cs *cs, UINT src_start_id
     cs->ops->submit_and_wait(cs);
 }
 
-static void (* const wined3d_cs_op_handlers[])(struct wined3d_cs *cs, const void *data) =
+static UINT (* const wined3d_cs_op_handlers[])(struct wined3d_cs *cs, const void *data) =
 {
     /* WINED3D_CS_OP_SYNC                       */ wined3d_cs_exec_sync,
     /* WINED3D_CS_OP_GLFINISH                   */ wined3d_cs_exec_glfinish,
@@ -2401,6 +2512,201 @@ static const struct wined3d_cs_ops wined3d_cs_st_ops =
     wined3d_cs_st_submit,
 };
 
+static void wined3d_cs_list_enqueue(struct wined3d_cs_list *list, struct wined3d_cs_block *block)
+{
+    EnterCriticalSection(&list->lock);
+    list_add_tail(&list->blocks, &block->entry);
+    LeaveCriticalSection(&list->lock);
+    InterlockedIncrement(&list->count);
+}
+
+static struct wined3d_cs_block *wined3d_cs_list_dequeue(struct wined3d_cs_list *list)
+{
+    struct list *head;
+
+    if (!list->count) return NULL;
+    EnterCriticalSection(&list->lock);
+    if (!(head = list_head(&list->blocks)))
+    {
+        LeaveCriticalSection(&list->lock);
+        return NULL;
+    }
+    list_remove(head);
+    LeaveCriticalSection(&list->lock);
+    InterlockedDecrement(&list->count);
+
+    return LIST_ENTRY(head, struct wined3d_cs_block, entry);
+}
+
+static struct wined3d_cs_block *wined3d_cs_dequeue_command(struct wined3d_cs *cs)
+{
+    struct wined3d_cs_block *block;
+
+    /* FIXME: Use an event to wait after a couple of spins. */
+    for (;;)
+    {
+        if ((block = wined3d_cs_list_dequeue(&cs->exec_list)))
+            return block;
+    }
+}
+
+static void wined3d_cs_list_init(struct wined3d_cs_list *list)
+{
+    InitializeCriticalSection(&list->lock);
+    list->lock.DebugInfo->Spare[0] = (DWORD_PTR)(__FILE__ ": wined3d_cs_list_lock");
+
+    list_init(&list->blocks);
+}
+
+static void wined3d_cs_list_cleanup(struct wined3d_cs_list *list)
+{
+    struct wined3d_cs_block *block, *next;
+
+    LIST_FOR_EACH_ENTRY_SAFE(block, next, &list->blocks, struct wined3d_cs_block, entry)
+    {
+        list_remove(&block->entry);
+        HeapFree(GetProcessHeap(), 0, block);
+    }
+
+    list->lock.DebugInfo->Spare[0] = 0;
+    DeleteCriticalSection(&list->lock);
+}
+
+static struct wined3d_cs_block *wined3d_cs_get_block(struct wined3d_cs *cs)
+{
+    struct wined3d_cs_block *block;
+
+    if (!(block = wined3d_cs_list_dequeue(&cs->free_list)))
+    {
+        if (!(block = HeapAlloc(GetProcessHeap(), 0, sizeof(*block))))
+        {
+            ERR("Failed to get new block.\n");
+            return NULL;
+        }
+    }
+
+    block->pos = 0;
+    block->fence = NULL;
+
+    return block;
+}
+
+static void *wined3d_cs_mt_require_space(struct wined3d_cs *cs, size_t size)
+{
+    struct wined3d_cs_block *block;
+    void *data;
+
+    if (cs->thread_id == GetCurrentThreadId())
+        return wined3d_cs_st_require_space(cs, size);
+
+    assert(size <= sizeof(block->data));
+
+    block = cs->current_block;
+    if (!block || block->pos + size > sizeof(block->data))
+    {
+        if (block) cs->ops->submit(cs);
+        block = wined3d_cs_get_block(cs);
+        cs->current_block = block;
+    }
+
+    data = &block->data[block->pos];
+    block->pos += size;
+
+    return data;
+}
+
+/* static */ void wined3d_cs_mt_submit(struct wined3d_cs *cs)
+{
+    if (cs->thread_id == GetCurrentThreadId())
+        return wined3d_cs_st_submit(cs);
+
+    wined3d_cs_list_enqueue(&cs->exec_list, cs->current_block);
+    cs->current_block = NULL;
+}
+
+static void wined3d_cs_mt_submit_and_wait(struct wined3d_cs *cs)
+{
+    struct wined3d_cs_block *block;
+    BOOL fence = FALSE;
+
+    if (cs->thread_id == GetCurrentThreadId())
+        return wined3d_cs_st_submit(cs);
+
+    block = cs->current_block;
+    block->fence = &fence;
+    wined3d_cs_list_enqueue(&cs->exec_list, block);
+    cs->current_block = NULL;
+
+    /* A busy wait should be fine, we're not supposed to have to wait very
+     * long. */
+    while (!InterlockedCompareExchange(&fence, TRUE, TRUE));
+}
+
+static const struct wined3d_cs_ops wined3d_cs_mt_ops =
+{
+    wined3d_cs_mt_require_space,
+    wined3d_cs_mt_submit_and_wait,  /* FIXME */
+    wined3d_cs_mt_submit_and_wait,
+};
+
+static void wined3d_cs_mt_emit_stop(struct wined3d_cs *cs)
+{
+    struct wined3d_cs_stop *op;
+
+    assert(cs->thread_id != GetCurrentThreadId());
+    assert(cs->ops == &wined3d_cs_mt_ops);
+
+    op = cs->ops->require_space(cs, sizeof(*op));
+    op->opcode = WINED3D_CS_OP_STOP;
+
+    cs->ops->submit(cs);
+}
+
+static inline BOOL wined3d_cs_process_command(struct wined3d_cs *cs, struct wined3d_cs_block *block)
+{
+    UINT pos = 0;
+    BOOL ret = TRUE;
+
+    while (pos < block->pos)
+    {
+        enum wined3d_cs_op opcode = *(const enum wined3d_cs_op *)&block->data[pos];
+
+        if (opcode >= WINED3D_CS_OP_STOP)
+        {
+            if (opcode > WINED3D_CS_OP_STOP)
+                ERR("Invalid opcode %#x.\n", opcode);
+            ret = FALSE;
+            break;
+        }
+
+        pos += wined3d_cs_op_handlers[opcode](cs, &block->data[pos]);
+    }
+
+    if (block->fence)
+        InterlockedExchange(block->fence, TRUE);
+
+    wined3d_cs_list_enqueue(&cs->free_list, block);
+    return ret;
+}
+
+static DWORD WINAPI wined3d_cs_run(void *thread_param)
+{
+    struct wined3d_cs *cs = thread_param;
+
+    TRACE("Started.\n");
+
+    for (;;)
+    {
+        struct wined3d_cs_block *block;
+        block = wined3d_cs_dequeue_command(cs);
+        if (!wined3d_cs_process_command(cs, block))
+            break;
+    }
+
+    TRACE("Stopped.\n");
+    return 0;
+}
+
 struct wined3d_cs *wined3d_cs_create(struct wined3d_device *device)
 {
     const struct wined3d_gl_info *gl_info = &device->adapter->gl_info;
@@ -2430,12 +2736,41 @@ struct wined3d_cs *wined3d_cs_create(struct wined3d_device *device)
         return NULL;
     }
 
+    if (wined3d_settings.cs_multithreaded)
+    {
+        cs->ops = &wined3d_cs_mt_ops;
+
+        wined3d_cs_list_init(&cs->free_list);
+        wined3d_cs_list_init(&cs->exec_list);
+
+        if (!(cs->thread = CreateThread(NULL, 0, wined3d_cs_run, cs, 0, &cs->thread_id)))
+        {
+            ERR("Failed to create wined3d command stream thread.\n");
+            state_cleanup(&cs->state);
+            HeapFree(GetProcessHeap(), 0, cs->fb.render_targets);
+            HeapFree(GetProcessHeap(), 0, cs->data);
+            HeapFree(GetProcessHeap(), 0, cs);
+            return NULL;
+        }
+    }
+
     return cs;
 }
 
 void wined3d_cs_destroy(struct wined3d_cs *cs)
 {
     state_cleanup(&cs->state);
+
+    if (wined3d_settings.cs_multithreaded)
+    {
+        wined3d_cs_mt_emit_stop(cs);
+        WaitForSingleObject(cs->thread, INFINITE);
+        CloseHandle(cs->thread);
+
+        wined3d_cs_list_cleanup(&cs->exec_list);
+        wined3d_cs_list_cleanup(&cs->free_list);
+    }
+
     HeapFree(GetProcessHeap(), 0, cs->fb.render_targets);
     HeapFree(GetProcessHeap(), 0, cs->data);
     HeapFree(GetProcessHeap(), 0, cs);
diff --git a/dlls/wined3d/device.c b/dlls/wined3d/device.c
index e3a73a05658..25fa0f00f5c 100644
--- a/dlls/wined3d/device.c
+++ b/dlls/wined3d/device.c
@@ -1289,7 +1289,7 @@ UINT CDECL wined3d_device_get_available_texture_mem(const struct wined3d_device
 
     /* We can not acquire the context unless there is a swapchain. */
     if (device->swapchains && gl_info->supported[NVX_GPU_MEMORY_INFO] &&
-            !wined3d_settings.emulated_textureram)
+            !wined3d_settings.emulated_textureram && !wined3d_settings.cs_multithreaded)
     {
         GLint vram_free_kb;
         UINT64 vram_free;
diff --git a/dlls/wined3d/wined3d_main.c b/dlls/wined3d/wined3d_main.c
index e7962465279..a8409cfd4b8 100644
--- a/dlls/wined3d/wined3d_main.c
+++ b/dlls/wined3d/wined3d_main.c
@@ -90,6 +90,7 @@ struct wined3d_settings wined3d_settings =
     ~0U,            /* No PS shader model limit by default. */
     ~0u,            /* No CS shader model limit by default. */
     FALSE,          /* 3D support enabled by default. */
+    TRUE,           /* Multithreaded CS by default. */
 };
 
 struct wined3d * CDECL wined3d_create(DWORD flags)
@@ -327,8 +328,17 @@ static BOOL wined3d_dll_init(HINSTANCE hInstDLL)
             TRACE("Disabling 3D support.\n");
             wined3d_settings.no_3d = TRUE;
         }
+        if (!get_config_key(hkey, appkey, "CSMT", buffer, size)
+                && !strcmp(buffer,"disabled"))
+        {
+            TRACE("Disabling multithreaded command stream.\n");
+            wined3d_settings.cs_multithreaded = FALSE;
+        }
     }
 
+    FIXME_(winediag)("Experimental wined3d CSMT feature is currently %s.\n",
+        wined3d_settings.cs_multithreaded ? "enabled" : "disabled");
+
     if (appkey) RegCloseKey( appkey );
     if (hkey) RegCloseKey( hkey );
 
diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 8b5ea45ae61..e1516f0f0b0 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -306,6 +306,7 @@ struct wined3d_settings
     unsigned int max_sm_ps;
     unsigned int max_sm_cs;
     BOOL no_3d;
+    BOOL cs_multithreaded;
 };
 
 extern struct wined3d_settings wined3d_settings DECLSPEC_HIDDEN;
@@ -2773,11 +2774,6 @@ static inline void wined3d_resource_release(struct wined3d_resource *resource)
     InterlockedDecrement(&resource->access_count);
 }
 
-static inline void wined3d_resource_wait_idle(struct wined3d_resource *resource)
-{
-    while (InterlockedCompareExchange(&resource->access_count, 0, 0));
-}
-
 void resource_cleanup(struct wined3d_resource *resource) DECLSPEC_HIDDEN;
 HRESULT resource_init(struct wined3d_resource *resource, struct wined3d_device *device,
         enum wined3d_resource_type type, const struct wined3d_format *format,
@@ -3198,6 +3194,21 @@ enum wined3d_push_constants
     WINED3D_PUSH_CONSTANTS_PS_B,
 };
 
+struct wined3d_cs_list
+{
+    CRITICAL_SECTION lock;
+    struct list blocks;
+    LONG count;
+};
+
+struct wined3d_cs_block
+{
+    struct list entry;
+    UINT pos;
+    BOOL *fence;
+    BYTE data[0x4000]; /* FIXME? The size is somewhat arbitrary. */
+};
+
 struct wined3d_cs_ops
 {
     void *(*require_space)(struct wined3d_cs *cs, size_t size);
@@ -3215,9 +3226,21 @@ struct wined3d_cs
     size_t data_size, start, end;
     void *data;
 
+    HANDLE thread;
+    DWORD thread_id;
+    struct wined3d_cs_block *current_block;
+    struct wined3d_cs_list free_list;
+    struct wined3d_cs_list exec_list;
+
     LONG pending_presents;
 };
 
+static inline void wined3d_resource_wait_idle(struct wined3d_resource *resource)
+{
+    if (resource->device->cs->thread_id == GetCurrentThreadId()) return;
+    while (InterlockedCompareExchange(&resource->access_count, 0, 0));
+}
+
 struct wined3d_cs *wined3d_cs_create(struct wined3d_device *device) DECLSPEC_HIDDEN;
 void wined3d_cs_destroy(struct wined3d_cs *cs) DECLSPEC_HIDDEN;
 void wined3d_cs_destroy_object(struct wined3d_cs *cs,
-- 
2.11.0

