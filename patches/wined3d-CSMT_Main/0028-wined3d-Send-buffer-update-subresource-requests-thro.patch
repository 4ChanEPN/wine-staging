From f0062383c0837e2faa414c042f4b93506a40501b Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Tue, 7 Feb 2017 14:01:52 +0100
Subject: wined3d: Send buffer update subresource requests through CS.

---
 dlls/wined3d/cs.c     | 11 +++++++++++
 dlls/wined3d/device.c |  7 +------
 2 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index cdd11e41c91..d2aacaa261a 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -2233,6 +2233,17 @@ static UINT wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const voi
     struct wined3d_texture *texture;
     unsigned int width, height, depth, level;
 
+    if (op->resource->type == WINED3D_RTYPE_BUFFER)
+    {
+        struct wined3d_buffer *buffer = buffer_from_resource(op->resource);
+        HRESULT hr;
+
+        if (FAILED(hr = wined3d_buffer_upload_data(buffer, op->box, op->data)))
+            WARN("Failed to update buffer data, hr %#x.\n", hr);
+
+        return sizeof(*op);
+    }
+
     texture = wined3d_texture_from_resource(op->resource);
 
     level = op->sub_resource_idx % texture->level_count;
diff --git a/dlls/wined3d/device.c b/dlls/wined3d/device.c
index f3412088483..8a02e5db229 100644
--- a/dlls/wined3d/device.c
+++ b/dlls/wined3d/device.c
@@ -4153,18 +4153,13 @@ void CDECL wined3d_device_update_sub_resource(struct wined3d_device *device, str
 
     if (resource->type == WINED3D_RTYPE_BUFFER)
     {
-        struct wined3d_buffer *buffer = buffer_from_resource(resource);
-        HRESULT hr;
-
         if (sub_resource_idx > 0)
         {
             WARN("Invalid sub_resource_idx %u.\n", sub_resource_idx);
             return;
         }
 
-        if (FAILED(hr = wined3d_buffer_upload_data(buffer, box, data)))
-            WARN("Failed to update buffer data, hr %#x.\n", hr);
-
+        wined3d_cs_emit_update_sub_resource(device->cs, resource, sub_resource_idx, box, data, row_pitch, depth_pitch);
         return;
     }
 
-- 
2.11.0

