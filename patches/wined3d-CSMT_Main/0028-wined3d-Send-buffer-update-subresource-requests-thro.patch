From 0565d5be2c6a7d904777fcd5de6903bec9a6ab1a Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Tue, 7 Feb 2017 14:01:52 +0100
Subject: wined3d: Send buffer update subresource requests through CS.

---
 dlls/wined3d/cs.c     | 19 +++++++++++++++++++
 dlls/wined3d/device.c | 15 +--------------
 2 files changed, 20 insertions(+), 14 deletions(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index cdd11e41c91..594662fbd83 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -2233,6 +2233,25 @@ static UINT wined3d_cs_exec_update_sub_resource(struct wined3d_cs *cs, const voi
     struct wined3d_texture *texture;
     unsigned int width, height, depth, level;
 
+    if (op->resource->type == WINED3D_RTYPE_BUFFER)
+    {
+        struct wined3d_buffer *buffer = buffer_from_resource(op->resource);
+
+        context = context_acquire(op->resource->device, NULL);
+        if (!wined3d_buffer_load_location(buffer, context, WINED3D_LOCATION_BUFFER))
+        {
+            ERR("Failed to load buffer location.\n");
+        }
+        else
+        {
+            wined3d_buffer_upload_data(buffer, context, op->box, op->data);
+            wined3d_buffer_invalidate_location(buffer, ~WINED3D_LOCATION_BUFFER);
+        }
+        context_release(context);
+
+        return sizeof(*op);
+    }
+
     texture = wined3d_texture_from_resource(op->resource);
 
     level = op->sub_resource_idx % texture->level_count;
diff --git a/dlls/wined3d/device.c b/dlls/wined3d/device.c
index 151e41bb2e3..5ac6e992bae 100644
--- a/dlls/wined3d/device.c
+++ b/dlls/wined3d/device.c
@@ -4229,26 +4229,13 @@ void CDECL wined3d_device_update_sub_resource(struct wined3d_device *device, str
 
     if (resource->type == WINED3D_RTYPE_BUFFER)
     {
-        struct wined3d_buffer *buffer = buffer_from_resource(resource);
-        struct wined3d_context *context;
-
         if (sub_resource_idx > 0)
         {
             WARN("Invalid sub_resource_idx %u.\n", sub_resource_idx);
             return;
         }
 
-        context = context_acquire(resource->device, NULL);
-        if (!wined3d_buffer_load_location(buffer, context, WINED3D_LOCATION_BUFFER))
-        {
-            ERR("Failed to load buffer location.\n");
-            return;
-        }
-
-        wined3d_buffer_upload_data(buffer, context, box, data);
-        wined3d_buffer_invalidate_location(buffer, ~WINED3D_LOCATION_BUFFER);
-        context_release(context);
-
+        wined3d_cs_emit_update_sub_resource(device->cs, resource, sub_resource_idx, box, data, row_pitch, depth_pitch);
         return;
     }
 
-- 
2.11.0

