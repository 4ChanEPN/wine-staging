From 61a6817b9406946c5ee42dd5e3c4ca4fd6f8415b Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Sun, 12 Feb 2017 00:08:28 +0100
Subject: wined3d: Use priority queue for update_sub_resource.

---
 dlls/wined3d/cs.c     | 2 +-
 dlls/wined3d/device.c | 2 ++
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/dlls/wined3d/cs.c b/dlls/wined3d/cs.c
index 09936328cf4..2aae8ca6a55 100644
--- a/dlls/wined3d/cs.c
+++ b/dlls/wined3d/cs.c
@@ -2326,7 +2326,7 @@ void wined3d_cs_emit_update_sub_resource(struct wined3d_cs *cs, struct wined3d_r
 {
     struct wined3d_cs_update_sub_resource *op;
 
-    op = cs->ops->require_space(cs, sizeof(*op), 0);
+    op = cs->ops->require_space(cs, sizeof(*op), 1);
     op->opcode = WINED3D_CS_OP_UPDATE_SUB_RESOURCE;
     op->resource = resource;
     op->sub_resource_idx = sub_resource_idx;
diff --git a/dlls/wined3d/device.c b/dlls/wined3d/device.c
index b98780000b0..f5edbbba84b 100644
--- a/dlls/wined3d/device.c
+++ b/dlls/wined3d/device.c
@@ -4149,6 +4149,8 @@ void CDECL wined3d_device_update_sub_resource(struct wined3d_device *device, str
     TRACE("device %p, resource %p, sub_resource_idx %u, box %s, data %p, row_pitch %u, depth_pitch %u.\n",
             device, resource, sub_resource_idx, debug_box(box), data, row_pitch, depth_pitch);
 
+    wined3d_resource_wait_idle(resource);
+
     if (resource->type == WINED3D_RTYPE_BUFFER)
     {
         if (sub_resource_idx > 0)
-- 
2.11.0

