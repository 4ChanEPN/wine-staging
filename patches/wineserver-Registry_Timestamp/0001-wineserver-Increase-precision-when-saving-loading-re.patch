From b802fbbf522c400c30d26170152daa5e1f41f94d Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Michael=20M=C3=BCller?= <michael@fds-team.de>
Date: Tue, 28 Jul 2015 17:46:13 +0200
Subject: wineserver: Increase precision when saving / loading registry
 modification date

---
 server/registry.c | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

diff --git a/server/registry.c b/server/registry.c
index 43527df..45eebb8 100644
--- a/server/registry.c
+++ b/server/registry.c
@@ -264,7 +264,8 @@ static void save_subkeys( const struct key *key, const struct key *base, FILE *f
     {
         fprintf( f, "\n[" );
         if (key != base) dump_path( key, base, f );
-        fprintf( f, "] %u\n", (unsigned int)((key->modif - ticks_1601_to_1970) / TICKS_PER_SEC) );
+        fprintf( f, "] %u %u\n", (unsigned int)((key->modif - ticks_1601_to_1970) / TICKS_PER_SEC),
+                                 (unsigned int)((key->modif - ticks_1601_to_1970) % TICKS_PER_SEC) );
         if (key->class)
         {
             fprintf( f, "#class=\"" );
@@ -1347,9 +1348,10 @@ static struct key *load_key( struct key *base, const char *buffer,
     WCHAR *p;
     struct unicode_str name;
     int res;
-    unsigned int mod;
+    unsigned int mod, mod_nano;
     timeout_t modif = current_time;
     data_size_t len;
+    int elements;
 
     if (!get_file_tmp_space( info, strlen(buffer) * sizeof(WCHAR) )) return NULL;
 
@@ -1359,8 +1361,9 @@ static struct key *load_key( struct key *base, const char *buffer,
         file_read_error( "Malformed key", info );
         return NULL;
     }
-    if (sscanf( buffer + res, " %u", &mod ) == 1)
-        modif = (timeout_t)mod * TICKS_PER_SEC + ticks_1601_to_1970;
+    elements = sscanf( buffer + res, " %u %u", &mod, &mod_nano );
+    if (elements >= 1) modif = (timeout_t)mod * TICKS_PER_SEC + ticks_1601_to_1970;
+    if (elements >= 2) modif += mod_nano;
 
     p = info->tmp;
     while (prefix_len && *p) { if (*p++ == '\\') prefix_len--; }
-- 
2.4.5

