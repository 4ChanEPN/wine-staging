From ed0734ad10de657efb30ec7c851d20d20ba79a0a Mon Sep 17 00:00:00 2001
From: Sebastian Lackner <sebastian@fds-team.de>
Date: Sat, 11 Jul 2015 19:19:00 +0200
Subject: vcomp: Implement _vcomp_for_static_init.

---
 dlls/vcomp/main.c           | 62 +++++++++++++++++++++++++++++++++++++++++++++
 dlls/vcomp/vcomp.spec       |  2 +-
 dlls/vcomp100/vcomp100.spec |  2 +-
 dlls/vcomp90/vcomp90.spec   |  2 +-
 4 files changed, 65 insertions(+), 3 deletions(-)

diff --git a/dlls/vcomp/main.c b/dlls/vcomp/main.c
index fcbd747..b22dd37 100644
--- a/dlls/vcomp/main.c
+++ b/dlls/vcomp/main.c
@@ -386,6 +386,68 @@ void CDECL _vcomp_for_static_simple_init(unsigned int first, unsigned int last,
     }
 }
 
+void CDECL _vcomp_for_static_init(int first, int last, int step, int chunksize, unsigned int *loops,
+                                  int *begin, int *end, int *next, int *lastchunk)
+{
+    struct vcomp_thread_data *thread_data = vcomp_get_thread_data();
+    struct vcomp_team_data *team_data = thread_data->team;
+    unsigned int iterations, num_chunks, per_thread, remaining;
+    DWORD num_threads, thread_num;
+
+    TRACE("(%d, %d, %d, %d, %p, %p, %p, %p, %p)\n",
+          first, last, step, chunksize, loops, begin, end, next, lastchunk);
+
+    num_threads = team_data->num_threads;
+    thread_num  = thread_data->thread_num;
+
+    if (chunksize < 1)
+        chunksize = 1;
+
+    if (num_threads == 1 && chunksize > 1)
+    {
+        *loops = 1;
+        *begin = first;
+        *end   = last;
+        *next = chunksize;
+        *lastchunk = first;
+    }
+    else if (last > first)
+    {
+        iterations = 1 + (last - first) / step;
+        num_chunks = (iterations + chunksize - 1) / chunksize;
+        per_thread = num_chunks / num_threads;
+        remaining  = num_chunks - per_thread * num_threads;
+
+        *loops = per_thread + (thread_num < remaining);
+        *begin = first + thread_num * chunksize * step;
+        *end   = *begin + (chunksize - 1) * step;
+        *next = chunksize * num_threads * step;
+        *lastchunk = first + (num_chunks - 1) * chunksize * step;
+
+    }
+    else if (last < first)
+    {
+        iterations = 1 + (first - last) / step;
+        num_chunks = (iterations + chunksize - 1) / chunksize;
+        per_thread = num_chunks / num_threads;
+        remaining  = num_chunks - per_thread * num_threads;
+
+        *loops = per_thread + (thread_num < remaining);
+        *begin = first - thread_num * chunksize * step;
+        *end   = *begin - (chunksize - 1) * step;
+        *next = - chunksize * num_threads * step;
+        *lastchunk = first - (num_chunks - 1) * chunksize * step;
+    }
+    else
+    {
+        *loops = (thread_num == 0);
+        *begin = first;
+        *end   = last;
+        *next = 0;
+        *lastchunk = first;
+    }
+}
+
 void CDECL _vcomp_for_static_end(void)
 {
     TRACE("()\n");
diff --git a/dlls/vcomp/vcomp.spec b/dlls/vcomp/vcomp.spec
index b14edca..8bc66e8 100644
--- a/dlls/vcomp/vcomp.spec
+++ b/dlls/vcomp/vcomp.spec
@@ -60,7 +60,7 @@
 @ stub _vcomp_for_dynamic_next
 @ stub _vcomp_for_dynamic_next_i8
 @ cdecl _vcomp_for_static_end()
-@ stub _vcomp_for_static_init
+@ cdecl _vcomp_for_static_init(long long long long ptr ptr ptr ptr ptr)
 @ stub _vcomp_for_static_init_i8
 @ cdecl _vcomp_for_static_simple_init(long long long long ptr ptr)
 @ stub _vcomp_for_static_simple_init_i8
diff --git a/dlls/vcomp100/vcomp100.spec b/dlls/vcomp100/vcomp100.spec
index 89e0972..f008e2e 100644
--- a/dlls/vcomp100/vcomp100.spec
+++ b/dlls/vcomp100/vcomp100.spec
@@ -60,7 +60,7 @@
 @ stub _vcomp_for_dynamic_next
 @ stub _vcomp_for_dynamic_next_i8
 @ cdecl _vcomp_for_static_end() vcomp._vcomp_for_static_end
-@ stub _vcomp_for_static_init
+@ cdecl _vcomp_for_static_init(long long long long ptr ptr ptr ptr ptr) vcomp._vcomp_for_static_init
 @ stub _vcomp_for_static_init_i8
 @ cdecl _vcomp_for_static_simple_init(long long long long ptr ptr) vcomp._vcomp_for_static_simple_init
 @ stub _vcomp_for_static_simple_init_i8
diff --git a/dlls/vcomp90/vcomp90.spec b/dlls/vcomp90/vcomp90.spec
index 89e0972..f008e2e 100644
--- a/dlls/vcomp90/vcomp90.spec
+++ b/dlls/vcomp90/vcomp90.spec
@@ -60,7 +60,7 @@
 @ stub _vcomp_for_dynamic_next
 @ stub _vcomp_for_dynamic_next_i8
 @ cdecl _vcomp_for_static_end() vcomp._vcomp_for_static_end
-@ stub _vcomp_for_static_init
+@ cdecl _vcomp_for_static_init(long long long long ptr ptr ptr ptr ptr) vcomp._vcomp_for_static_init
 @ stub _vcomp_for_static_init_i8
 @ cdecl _vcomp_for_static_simple_init(long long long long ptr ptr) vcomp._vcomp_for_static_simple_init
 @ stub _vcomp_for_static_simple_init_i8
-- 
2.4.5

